<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhenomeBeauty Booking v3.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
      :root {
        --accent: #F4C2C2;
        --accent-2: #e8aaaa;
        --bg-dark: #fef0f0;
        --bg-card: #ffffff;
        --border: rgba(244, 194, 194, 0.4);
        --border-hi: #333333;
        --text: #333333;
        --text-muted: #888888;
        --shadow: 0 18px 60px rgba(244,194,194,0.18);
        --r-lg: 24px;
        --r-md: 16px;
        --r-sm: 12px;
        --r-pill: 999px;
      }
      *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      html, body {
        margin: 0; padding: 0; height: 100%;
        font-family: Inter, system-ui, -apple-system, sans-serif;
        color: var(--text);
        background:
          radial-gradient(circle at 0% 0%, #fce8e8 0, transparent 55%),
          radial-gradient(circle at 100% 0%, #fdf0f0 0, transparent 55%),
          radial-gradient(circle at 0% 100%, #fff5f5 0, transparent 55%),
          #fef0f0;
      }
      /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
      .app-frame {
        width: 100%; min-height: 100vh;
        padding: 14px 10px 20px;
        display: flex; align-items: stretch; justify-content: center;
      }
      .shell {
        width: 100%; max-width: 520px;
        min-height: calc(100vh - 32px);
        border-radius: var(--r-lg);
        padding: 18px 14px;
        background: #ffffff;
        box-shadow: 0 24px 70px rgba(244,194,194,0.2), 0 0 0 1px rgba(244,194,194,0.25);
        backdrop-filter: blur(24px) saturate(180%);
        display: flex; flex-direction: column;
      }
      @media(min-width:768px){
        .app-frame{ padding: 32px 16px; }
        .shell{ border-radius: 30px; padding: 24px 22px; }
      }
      /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
      header {
        display: flex; flex-direction: column; align-items: center;
        margin-bottom: 16px;
      }
      .logo-wrap {
        width: 80px; height: 80px;
        border-radius: 26px; padding: 2px;
        background: radial-gradient(circle at 0 0, rgba(255,255,255,0.9), transparent 60%),
                    radial-gradient(circle at 100% 100%, rgba(244,194,194,0.5), transparent 60%);
        box-shadow: 0 14px 40px rgba(244,194,194,0.3);
      }
      .logo {
        width: 100%; height: 100%; border-radius: 22px;
        object-fit: cover; background: #fff5f5;
        border: 1px solid rgba(244,194,194,0.4);
        display: block;
      }
      .brand-tag { margin-top: 12px; font-size: 10px; letter-spacing: 0.17em; text-transform: uppercase; color: rgba(51,51,51,0.45); }
      h1 { margin: 5px 0 2px; font-size: 20px; font-weight: 400; letter-spacing: -0.01em; font-family: 'Playfair Display', Georgia, serif; }
      .sub-heading { font-size: 11.5px; color: var(--text-muted); margin-bottom: 12px; }
      /* Steps */
      .step-indicator {
        display: flex; align-items: center; gap: 6px;
        padding: 6px 10px; border-radius: var(--r-pill);
        background: rgba(244,194,194,0.1);
        border: 1px solid rgba(244,194,194,0.3);
      }
      .step-pill {
        flex: 1; height: 4px; border-radius: var(--r-pill);
        background: rgba(0,0,0,0.07); overflow: hidden;
      }
      .step-pill-inner {
        width: 0; height: 100%; border-radius: inherit;
        background: linear-gradient(90deg, var(--accent-2), var(--accent));
        transition: width 0.3s ease;
      }
      .step-label { font-size: 10.5px; color: var(--text-muted); margin-top: 4px; }
      /* ‚îÄ‚îÄ SURFACE ‚îÄ‚îÄ */
      .surface {
        flex: 1; margin-top: 10px;
        padding: 14px;
        border-radius: var(--r-lg);
        background: #ffffff;
        box-shadow: var(--shadow);
        border: 1px solid rgba(244,194,194,0.3);
        backdrop-filter: none;
        display: flex; flex-direction: column;
        overflow: hidden;
      }
      .surface-inner {
        position: relative; z-index: 1;
        display: flex; flex-direction: column;
        flex: 1; min-height: 0;
      }
      .view { display: none; height: 100%; }
      .view.active {
        display: flex; flex-direction: column;
        animation: fadeIn 0.3s ease-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .section-label {
        font-size: 10px; letter-spacing: 0.22em;
        text-transform: uppercase; color: var(--text-muted);
        margin-bottom: 14px; flex-shrink: 0;
        font-weight: 500;
      }
      .scroll-area {
        overflow-y: auto; padding-right: 2px;
        flex: 1; min-height: 0;
        -webkit-overflow-scrolling: touch;
      }
      /* ‚îÄ‚îÄ CATEGORY CHIPS ‚îÄ‚îÄ */
      .chip-row {
        display: flex; flex-wrap: nowrap; gap: 8px;
        margin-bottom: 16px; overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; padding-bottom: 4px;
      }
      .chip-row::-webkit-scrollbar { display: none; }
      .chip {
        border-radius: var(--r-pill);
        padding: 5px 11px; font-size: 11px; font-weight: 500;
        border: 1px solid var(--border);
        background: var(--bg-card); color: rgba(0,0,0,0.75);
        cursor: pointer; transition: all 0.18s ease;
      }
      .chip.active {
        background: #333333; color: #ffffff;
        border-color: rgba(248,250,252,0.9); color: #ffffff;
      }
      /* ‚îÄ‚îÄ SERVICE CARDS ‚îÄ‚îÄ */
      .category-title {
        font-size: 10.5px; font-weight: 600;
        text-transform: uppercase; letter-spacing: 0.14em;
        color: var(--text-muted);
        margin: 14px 0 8px; padding-left: 10px;
        position: relative;
      }
      .category-title::before {
        content: '';
        position: absolute; left: 0; top: 50%; transform: translateY(-50%);
        width: 3px; height: 16px; border-radius: var(--r-pill);
        background: linear-gradient(180deg, #E8CBA9, #000000);
      }
      .service-card {
        border-radius: 18px; padding: 18px 16px;
        margin-bottom: 10px;
        display: flex; align-items: center; justify-content: space-between;
        background: #ffffff;
        border: 1.5px solid rgba(0,0,0,0.08);
        box-shadow: 0 2px 12px rgba(0,0,0,0.05);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease,
                    border-color 0.2s ease, background 0.2s ease;
      }
      .service-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 40px rgba(244,194,194,0.25);
        border-color: rgba(244,194,194,0.7);
      }
      .service-card.selected {
        background: linear-gradient(135deg, #000000, #F7ECD8);
        border-color: #000000;
        border-width: 1.5px;
        box-shadow: 0 6px 24px rgba(0,0,0,0.12);
      }
      .service-main { flex: 1; margin-right: 12px; }
      .service-header {
        display: flex; justify-content: space-between; align-items: baseline; gap: 8px;
      }
      .service-name { font-size: 15px; font-weight: 600; letter-spacing: -0.01em; color: #1C1008; }
      .service-price { font-size: 15px; font-weight: 600; white-space: nowrap; color: #000000; }
      .service-meta { margin-top: 5px; font-size: 12px; color: rgba(0,0,0,0.55); line-height: 1.4; }
      /* Check circle */
      .check-circle {
        width: 26px; height: 26px; flex-shrink: 0;
        border-radius: 50%;
        border: 1.5px solid rgba(0,0,0,0.2);
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s ease;
        background: #fff;
      }
      .service-card.selected .service-meta { color: rgba(255,255,255,0.55); }
      .service-card.selected .service-price { color: #ffffff; }
      .service-card.selected .check-circle {
        background: linear-gradient(135deg, #000000, #a8744e);
        border-color: transparent;
        box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      }
      .check-circle svg { display: none; }
      .service-card.selected .check-circle svg { display: block; }
      /* ‚îÄ‚îÄ CART BAR ‚îÄ‚îÄ */
      .cart-bar {
        margin-top: 10px; flex-shrink: 0;
        border-radius: var(--r-md);
        padding: 10px 12px;
        background: linear-gradient(135deg, #000000, #F5E8D8);
        border: 1.5px solid rgba(0,0,0,0.2);
        display: none; /* shown via JS when items selected */
      }
      .cart-bar.visible { display: block; }
      .cart-bar-top {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 6px;
      }
      .cart-title {
        font-size: 11px; font-weight: 600;
        text-transform: uppercase; letter-spacing: 0.13em;
        color: var(--accent);
      }
      .cart-total {
        font-size: 14px; font-weight: 700;
      }
      .cart-items { display: flex; flex-direction: column; gap: 3px; }
      .cart-item {
        display: flex; justify-content: space-between; align-items: center;
        font-size: 11.5px;
      }
      .cart-item-name { color: var(--text-muted); flex: 1; margin-right: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .cart-item-price { color: var(--text); white-space: nowrap; }
      .cart-remove {
        margin-left: 6px; cursor: pointer;
        color: rgba(0,0,0,0.3); font-size: 12px; font-weight: 700;
        transition: color 0.15s;
      }
      .cart-remove:hover { color: #000000; }
      .cart-duration {
        margin-top: 6px; font-size: 10px; color: var(--text-muted);
      }
      /* ‚îÄ‚îÄ CUSTOM CALENDAR ‚îÄ‚îÄ */
      .cal-wrap {
        border-radius: var(--r-md);
        background: var(--bg-card);
        border: 1px solid rgba(0,0,0,0.08);
        overflow: hidden;
        margin-bottom: 14px;
      }
      .cal-header {
        display: flex; align-items: center; justify-content: space-between;
        padding: 10px 14px;
        border-bottom: 1px solid rgba(0,0,0,0.07);
      }
      .cal-month-label {
        font-size: 13px; font-weight: 600; letter-spacing: 0.01em;
      }
      .cal-nav {
        width: 30px; height: 30px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; border: 1px solid rgba(0,0,0,0.16);
        background: #000000;
        color: var(--text); font-size: 15px; line-height: 1;
        transition: background 0.18s, border-color 0.18s;
        user-select: none;
      }
      .cal-nav:hover { background: rgba(0,0,0,0.08); border-color: rgba(0,0,0,0.4); }
      .cal-nav.disabled { opacity: 0.25; cursor: not-allowed; pointer-events: none; }
      .cal-weekdays {
        display: grid; grid-template-columns: repeat(7, 1fr);
        padding: 6px 10px 2px;
      }
      .cal-wd {
        text-align: center; font-size: 10px;
        color: rgba(0,0,0,0.45);
        font-weight: 600; letter-spacing: 0.08em;
        padding: 2px 0;
      }
      .cal-days {
        display: grid; grid-template-columns: repeat(7, 1fr);
        gap: 3px; padding: 4px 10px 10px;
      }
      .cal-day {
        aspect-ratio: 1; border-radius: 10px;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        font-size: 12.5px; cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.15s ease;
        position: relative;
        user-select: none;
      }
      .cal-day.empty { pointer-events: none; }
      .cal-day.past {
        opacity: 0.22; cursor: not-allowed; pointer-events: none;
      }
      .cal-day.no-slots {
        opacity: 0.35; cursor: not-allowed; pointer-events: none;
      }
      .cal-day.has-slots {
        background: rgba(0,0,0,0.04);
        border-color: rgba(0,0,0,0.12);
      }
      .cal-day.has-slots:hover {
        background: rgba(0,0,0,0.08);
        border-color: rgba(0,0,0,0.35);
        transform: scale(1.08);
      }
      .cal-day.loading-month {
        background: rgba(0,0,0,0.03);
        border-color: rgba(0,0,0,0.06);
        pointer-events: none;
      }
      .cal-day.selected {
        background: #000000 !important;
        border-color: #000000 !important;
        color: #ffffff !important; font-weight: 700;
        box-shadow: 0 4px 14px rgba(0,0,0,0.25);
        transform: scale(1.1);
      }
      .cal-day.today:not(.selected):not(.past) {
        border-color: rgba(0,0,0,0.3);
        font-weight: 700;
      }
      .cal-day-dot {
        width: 4px; height: 4px; border-radius: 50%;
        background: rgba(0,0,0,0.4);
        position: absolute; bottom: 4px;
      }
      .cal-day.selected .cal-day-dot { background: rgba(255,255,255,0.45); }
      /* Time slots */
      .time-section-label {
        font-size: 10.5px; letter-spacing: 0.14em; text-transform: uppercase;
        color: var(--text-muted); margin-bottom: 7px;
      }
      .time-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 7px;
      }
      .time-slot {
        border-radius: var(--r-sm); padding: 9px 4px;
        font-size: 12.5px; text-align: center; cursor: pointer;
        background: var(--bg-card); color: var(--text);
        border: 1px solid rgba(0,0,0,0.2);
        transition: all 0.15s ease; user-select: none;
        animation: fadeIn 0.2s ease;
      }
      .time-slot:hover { border-color: #000000; background: rgba(0,0,0,0.04); }
      .time-slot.selected {
        background: #000000;
        border-color: #000000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.18);
        color: #ffffff; font-weight: 600;
      }
      .cal-month-loading {
        text-align: center; padding: 20px 0;
        font-size: 11px; color: var(--text-muted);
      }
      /* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
      .form-group { margin-bottom: 11px; position: relative; }
      /* ‚îÄ‚îÄ SAFETY YES/NO TOGGLES ‚îÄ‚îÄ */
      .safety-q-wrap { border-bottom: 1px solid rgba(0,0,0,0.06); padding-bottom: 12px; }
      .safety-q-label { font-size: 13px; font-weight: 500; color: var(--text); margin-bottom: 10px; line-height: 1.5; }
      .safety-yn { display: flex; gap: 8px; margin-bottom: 0; }
      .syn-btn {
        flex: 1; padding: 9px; border-radius: 10px; border: 1px solid var(--border);
        background: rgba(0,0,0,0.03); color: var(--text-muted);
        font-size: 13px; font-weight: 600; font-family: inherit; cursor: pointer;
        transition: all 0.15s;
      }
      .syn-btn[data-v="no"].active  { background: rgba(0,0,0,0.07);  border-color: #000000; color: #000000; }
      .syn-btn[data-v="yes"].active { background: rgba(0,0,0,0.08);  border-color: #000000; color: #000000; }
      .safety-detail {
        width: 100%; margin-top: 10px; padding: 10px 13px;
        background: rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.09);
        border-radius: var(--r-sm); color: var(--text);
        font-family: inherit; font-size: 13px; outline: none;
        resize: vertical; min-height: 56px;
        animation: fadeIn 0.15s ease;
      }
      @keyframes fadeIn { from { opacity:0; transform: translateY(-4px); } to { opacity:1; transform:none; } }
      label {
        display: block; font-size: 10.5px; font-weight: 500;
        margin-bottom: 4px; color: var(--text-muted);
      }
      .input-wrap {
        position: relative; display: flex; align-items: center;
      }
      .input-icon {
        position: absolute; left: 11px; top: 50%; transform: translateY(-50%);
        color: rgba(0,0,0,0.25); pointer-events: none; line-height: 1;
        font-size: 14px;
      }
      input[type="text"],
      input[type="email"],
      input[type="tel"] {
        width: 100%; border-radius: var(--r-sm); padding: 10px 11px;
        border: 1px solid rgba(0,0,0,0.2);
        background: #ffffff; color: var(--text);
        font-family: inherit; font-size: 13px; outline: none;
        transition: border-color 0.18s ease, box-shadow 0.18s ease;
      }
      input.has-icon { padding-left: 34px; }
      input[type="text"]:focus,
      input[type="email"]:focus,
      input[type="tel"]:focus {
        border-color: #000000;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
      }
      input.input-valid {
        border-color: rgba(0,0,0,0.07);
      }
      input.input-error {
        border-color: rgba(248,113,113,0.8);
        box-shadow: 0 0 0 1px rgba(248,113,113,0.3);
      }
      .field-hint {
        font-size: 10px; color: rgba(0,0,0,0.42);
        margin-top: 3px; padding-left: 2px;
      }
      /* ‚îÄ‚îÄ Custom address autocomplete dropdown ‚îÄ‚îÄ */
      .addr-suggestions {
        position: absolute; top: 100%; left: 0; right: 0; z-index: 9999;
        background: #ffffff;
        border: 1px solid rgba(0,0,0,0.08);
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.09);
        margin-top: 4px;
        overflow: hidden;
        display: none;
      }
      .addr-suggestions.open { display: block; }
      .addr-suggestion-item {
        padding: 9px 13px;
        font-size: 12.5px;
        color: rgba(248,250,252,0.9);
        border-top: 1px solid rgba(0,0,0,0.06);
        cursor: pointer;
        transition: background 0.12s;
        line-height: 1.4;
      }
      .addr-suggestion-item:first-child { border-top: none; }
      .addr-suggestion-item:hover,
      .addr-suggestion-item.active { background: rgba(0,0,0,0.08); }
      .addr-suggestion-main { font-weight: 500; }
      .addr-suggestion-sec { font-size: 11px; color: rgba(0,0,0,0.5); margin-top: 1px; }
      /* ‚îÄ‚îÄ SUMMARY ‚îÄ‚îÄ */
      .summary-card {
        border-radius: 18px; padding: 18px 16px;
        background: #ffffff;
        border: 1.5px solid rgba(0,0,0,0.08);
        box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      }
      .summary-row {
        display: flex; justify-content: space-between; align-items: baseline;
        gap: 8px; font-size: 13px; margin-bottom: 7px;
      }
      .summary-label { color: var(--text-muted); }
      .summary-value { text-align: right; font-size: 12.5px; max-width: 58%; }
      .summary-divider { margin: 8px 0; border-top: 1px solid rgba(0,0,0,0.12); }
      .summary-total-row {
        display: flex; justify-content: space-between; align-items: baseline;
        font-size: 15px; font-weight: 700; margin-bottom: 5px;
      }
      .summary-deposit-note {
        font-size: 11.5px; color: var(--text-muted); margin-bottom: 4px;
      }
      .summary-deposit-note strong { color: var(--text); }
      .fee-row {
        display: flex; justify-content: space-between; align-items: center;
        gap: 8px; font-size: 13px; margin-bottom: 7px;
      }
      .fee-label { color: var(--text-muted); font-size: 13px; }
      .fee-value { font-size: 13px; }
      .fee-calculating {
        font-size: 11px; color: rgba(0,0,0,0.08);
        display: flex; align-items: center; gap: 5px;
      }
      .summary-grand-total {
        display: flex; justify-content: space-between; align-items: baseline;
        font-size: 16px; font-weight: 700; margin: 4px 0 6px;
      }
      .summary-grand-total .accent { color: var(--accent); }
      .deposit-box {
        border-radius: 10px; padding: 9px 11px; margin: 8px 0;
        background: rgba(0,0,0,0.04);
        border: 1px solid rgba(0,0,0,0.09);
        display: flex; justify-content: space-between; align-items: center;
      }
      .deposit-box-label { font-size: 11.5px; color: var(--text-muted); }
      .deposit-box-amount { font-size: 15px; font-weight: 700; color: #000000; }
      .balance-note {
        font-size: 11px; color: var(--text-muted); text-align: right; margin-top: 3px;
      }
      .terms {
        margin-top: 10px; font-size: 10.5px; color: rgba(0,0,0,0.55);
        text-align: center; line-height: 1.5;
      }
      /* ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ */
      .actions { display: flex; gap: 10px; margin-top: 14px; flex-shrink: 0; }
      button {
        flex: 1; border-radius: 16px; padding: 11px 0;
        font-size: 13px; font-weight: 600; border: none;
        cursor: pointer; outline: none;
        transition: transform 0.16s ease, box-shadow 0.16s ease,
                    opacity 0.16s ease;
      }
      .btn-outline {
        background: #ffffff;
        color: #333333;
        border: 1px solid rgba(244,194,194,0.6);
      }
      .btn-outline:hover { transform: translateY(-1px); }
      .btn-primary {
        background: #333333;
        color: #ffffff;
        box-shadow: 0 16px 38px rgba(244,194,194,0.4);
      }
      .btn-primary:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 20px 48px rgba(244,194,194,0.5);
      }
      .btn-primary:disabled {
        background: rgba(30,41,59,0.9);
        color: rgba(0,0,0,0.45);
        box-shadow: none;
        border: 1px solid rgba(55,65,81,0.8);
        cursor: not-allowed;
      }
      /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
      .toast {
        position: fixed; left: 50%; bottom: 24px;
        transform: translateX(-50%) translateY(130%);
        min-width: 240px; max-width: 90vw;
        padding: 9px 16px; border-radius: var(--r-pill);
        font-size: 12px; font-weight: 500;
        color: var(--text);
        background: linear-gradient(135deg, #f9fafb, #e5e7eb);
        box-shadow: 0 16px 36px rgba(0,0,0,0.7);
        opacity: 0; z-index: 9999; text-align: center;
        transition: transform 0.28s cubic-bezier(0.18,0.89,0.32,1.28), opacity 0.28s ease;
      }
      .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
      .toast.error { background: linear-gradient(135deg,#fee2e2,#fecaca); color: #7f1d1d; }
      /* ‚îÄ‚îÄ LOADER ‚îÄ‚îÄ */
      .loader {
        display: inline-block; width: 17px; height: 17px;
        border-radius: 50%;
        border: 2px solid rgba(248,250,252,0.3);
        border-top-color: rgba(248,250,252,0.95);
        animation: spin 0.85s linear infinite;
        vertical-align: middle;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      /* Success screen */
      .success-view {
        display: none; flex-direction: column; align-items: center;
        justify-content: center; text-align: center; flex: 1; padding: 20px 0;
      }
      .success-view.active { display: flex; animation: fadeIn 0.4s ease; }
      .success-icon {
        width: 64px; height: 64px; border-radius: 50%;
        background: #000000;
        display: flex; align-items: center; justify-content: center;
        margin-bottom: 16px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      }
      .success-title { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
      .success-sub { font-size: 12px; color: var(--text-muted); line-height: 1.6; }
      .success-totals {
        margin-top: 18px; width: 100%;
        border-radius: var(--r-md); padding: 12px;
        background: #ffffff;
        border: 1px solid rgba(0,0,0,0.16);
        text-align: left;
      }
      .success-total-row {
        display: flex; justify-content: space-between;
        font-size: 12.5px; margin-bottom: 5px;
        color: var(--text-muted);
      }
      .success-total-row.highlight { color: #000000; font-weight: 700; font-size: 14px; }
      @keyframes shimmer { 0%,100% { opacity:0.6; } 50% { opacity:1; } }
    </style>
  </head>
  <body>
    <div class="app-frame">
      <div class="shell">
        <header>
          <div class="logo-wrap">
            <img src="https://iili.io/fpiAjBj.jpg" alt="PhenomeBeauty" class="logo">
          </div>
          <div class="brand-tag">Mobile Beauty Studio</div>
          <h1 id="view-title">Choose Services</h1>
          <div class="sub-heading">Premium At-Home Treatments</div>
          <div class="step-indicator">
            <div class="step-pill"><div class="step-pill-inner" id="step-bar-1"></div></div>
            <div class="step-pill"><div class="step-pill-inner" id="step-bar-2"></div></div>
            <div class="step-pill"><div class="step-pill-inner" id="step-bar-3"></div></div>
            <div class="step-pill"><div class="step-pill-inner" id="step-bar-4"></div></div>
          </div>
          <div class="step-label" id="step-label">Step 1 of 4 ¬∑ Services</div>
        </header>
        <div class="surface">
          <div class="surface-inner">
            <!-- Step 1: Services + Cart -->
            <div id="step-services" class="view active">
              <div class="section-label">Select your treatments</div>
              <div class="scroll-area" id="services-scroll">
                <div class="chip-row" id="category-chips"></div>
                <div id="services-list">
                  <div style="border-radius:16px;padding:14px;margin-bottom:7px;background:rgba(0,0,0,0.04);border:1px solid rgba(0,0,0,0.06);animation:shimmer 1.4s ease-in-out infinite;"><div style="height:12px;border-radius:6px;background:rgba(0,0,0,0.05);margin-bottom:8px;width:65%;"></div><div style="height:10px;border-radius:6px;background:rgba(0,0,0,0.04);width:40%;"></div></div>
                  <div style="border-radius:16px;padding:14px;margin-bottom:7px;background:rgba(0,0,0,0.04);border:1px solid rgba(0,0,0,0.06);animation:shimmer 1.4s ease-in-out infinite;animation-delay:0.2s;"><div style="height:12px;border-radius:6px;background:rgba(0,0,0,0.05);margin-bottom:8px;width:55%;"></div><div style="height:10px;border-radius:6px;background:rgba(0,0,0,0.04);width:35%;"></div></div>
                  <div style="border-radius:16px;padding:14px;margin-bottom:7px;background:rgba(0,0,0,0.04);border:1px solid rgba(0,0,0,0.06);animation:shimmer 1.4s ease-in-out infinite;animation-delay:0.4s;"><div style="height:12px;border-radius:6px;background:rgba(0,0,0,0.05);margin-bottom:8px;width:70%;"></div><div style="height:10px;border-radius:6px;background:rgba(0,0,0,0.04);width:45%;"></div></div>
                </div>
              </div>
              <!-- Cart bar sits below scroll, inside view -->
              <div class="cart-bar" id="cart-bar">
                <div class="cart-bar-top">
                  <span class="cart-title">üõí Your Cart</span>
                  <span class="cart-total" id="cart-total-price">R0</span>
                </div>
                <div class="cart-items" id="cart-items-list"></div>
                <div class="cart-duration" id="cart-duration"></div>
              </div>
            </div>
            <!-- Step 2: Date & Time -->
            <div id="step-datetime" class="view">
              <div class="section-label">Choose date &amp; time</div>
              <div class="scroll-area">
                <!-- Custom calendar -->
                <div class="cal-wrap">
                  <div class="cal-header">
                    <div class="cal-nav" id="cal-prev">&#8249;</div>
                    <div class="cal-month-label" id="cal-month-label">‚Äî</div>
                    <div class="cal-nav" id="cal-next">&#8250;</div>
                  </div>
                  <div class="cal-weekdays">
                    <div class="cal-wd">Su</div><div class="cal-wd">Mo</div>
                    <div class="cal-wd">Tu</div><div class="cal-wd">We</div>
                    <div class="cal-wd">Th</div><div class="cal-wd">Fr</div>
                    <div class="cal-wd">Sa</div>
                  </div>
                  <div id="cal-days" class="cal-days"></div>
                </div>
                <!-- Time slots (shown after date selected) -->
                <div id="time-section" style="display:none;">
                  <div class="time-section-label" id="time-section-label">Available times</div>
                  <div class="time-grid" id="time-grid"></div>
                </div>
              </div>
            </div>
            <!-- Step 3: Details -->
            <div id="step-details" class="view">
              <div class="section-label">Your details</div>
              <div class="scroll-area">

                <!-- Diva toggle -->
                <div class="form-group" style="margin-bottom:14px;">
                  <label style="margin-bottom:8px;display:block;">Have you booked with us before?</label>
                  <div style="display:flex;gap:8px;">
                    <button type="button" id="diva-existing" onclick="toggleDiva('existing')"
                      style="flex:1;padding:10px;border-radius:12px;border:1px solid var(--border);
                             background:rgba(0,0,0,0.08);color:#000000;font-weight:600;
                             font-size:13px;cursor:pointer;transition:all 0.15s;">
                      ‚ú® Existing Diva
                    </button>
                    <button type="button" id="diva-new" onclick="toggleDiva('new')"
                      style="flex:1;padding:10px;border-radius:12px;border:1px solid var(--border);
                             background:rgba(255,255,255,0.05);color:var(--text-muted);font-weight:600;
                             font-size:13px;cursor:pointer;transition:all 0.15s;">
                      üå∏ New Diva
                    </button>
                  </div>
                </div>

                <!-- Core fields (always shown) -->
                <div class="form-group">
                  <label for="client-name">Full Name</label>
                  <div class="input-wrap">
                    <span class="input-icon">üë§</span>
                    <input type="text" id="client-name" class="has-icon"
                           placeholder="Jane Smith" autocomplete="name"
                           maxlength="80" oninput="updateNextBtn()">
                  </div>
                </div>
                <div class="form-group">
                  <label for="client-phone">Phone Number</label>
                  <div class="input-wrap">
                    <span class="input-icon">üì±</span>
                    <input type="tel" id="client-phone" class="has-icon"
                           placeholder="082 123 4567" autocomplete="tel"
                           inputmode="tel" maxlength="12"
                           oninput="formatPhone(this)">
                  </div>
                  <div class="field-hint">SA mobile number ‚Äî e.g. 082 123 4567</div>
                </div>
                <div class="form-group">
                  <label for="client-email">Email Address</label>
                  <div class="input-wrap">
                    <span class="input-icon">‚úâÔ∏è</span>
                    <input type="email" id="client-email" class="has-icon"
                           placeholder="jane@example.com" autocomplete="email"
                           inputmode="email" maxlength="120"
                           oninput="validateEmail(this)">
                  </div>
                </div>
                <div class="form-group">
                  <label for="client-address">Home Address</label>
                  <div class="input-wrap" style="position:relative;flex-direction:column;align-items:stretch;">
                    <span class="input-icon" style="top:18px;">üìç</span>
                    <input type="text" id="client-address" class="has-icon"
                           placeholder="Start typing your address‚Ä¶" autocomplete="off" maxlength="200">
                    <div id="addr-suggestions" class="addr-suggestions"></div>
                  </div>
                  <div class="field-hint">Used to calculate your call-out fee</div>
                </div>

                <!-- Lead source (always shown) -->
                <div class="form-group">
                  <label for="client-source">How did you hear about us?</label>
                  <div class="input-wrap" style="padding:0;">
                    <select id="client-source"
                      style="width:100%;padding:13px 14px;background:rgba(0,0,0,0.4);
                             border:none;border-radius:var(--r-sm);color:var(--text);
                             font-family:inherit;font-size:14px;outline:none;cursor:pointer;
                             -webkit-appearance:none;">
                      <option value="">Select an option‚Ä¶</option>
                      <option value="Instagram">Instagram</option>
                      <option value="TikTok">TikTok</option>
                      <option value="Facebook">Facebook</option>
                      <option value="Google">Google Search</option>
                      <option value="Word of Mouth">Word of Mouth</option>
                      <option value="Referred by Friend">Referred by a Friend</option>
                      <option value="Returning Client">I'm a returning client</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                </div>

                <!-- Safety assessment ‚Äî new divas only -->
                <div id="safety-section" style="display:none;margin-top:4px;">
                  <div style="background:rgba(0,0,0,0.08);border:1px solid rgba(0,0,0,0.08);
                               border-radius:14px;padding:14px 16px;margin-bottom:14px;">
                    <div style="font-size:12px;font-weight:700;color:#000000;
                                text-transform:uppercase;letter-spacing:0.1em;margin-bottom:4px;">
                      üå∏ New Client Safety Check
                    </div>
                    <div style="font-size:12px;color:var(--text-muted);line-height:1.5;">
                      Answer all questions honestly. Your information is strictly confidential.
                    </div>
                    <a href="/policy.html" target="_blank"
                       style="display:inline-block;margin-top:8px;font-size:11.5px;font-weight:600;
                              color:#000000;text-decoration:underline;">
                      View full consultation &amp; policy document ‚Üó
                    </a>
                  </div>

                  <!-- Q1: Skin conditions -->
                  <div class="form-group safety-q-wrap">
                    <div class="safety-q-label">1. Any skin conditions in the treatment area?
                      <span style="color:var(--text-muted);font-weight:400;display:block;font-size:11.5px;margin-top:2px;">Rashes, cuts, sunburn, eczema, acne, etc.</span>
                    </div>
                    <div class="safety-yn" data-q="skin">
                      <button type="button" class="syn-btn" data-v="no" onclick="safetyToggle(this,'skin')">No</button>
                      <button type="button" class="syn-btn" data-v="yes" onclick="safetyToggle(this,'skin')">Yes</button>
                    </div>
                    <textarea id="safety-skin" class="safety-detail" maxlength="500"
                      placeholder="Please describe‚Ä¶" style="display:none;"></textarea>
                  </div>

                  <!-- Q2: Medications -->
                  <div class="form-group safety-q-wrap">
                    <div class="safety-q-label">2. Any medications or recent skin treatments?
                      <span style="color:var(--text-muted);font-weight:400;display:block;font-size:11.5px;margin-top:2px;">Retinoids, blood thinners, chemical peels, laser, etc.</span>
                    </div>
                    <div class="safety-yn" data-q="meds">
                      <button type="button" class="syn-btn" data-v="no" onclick="safetyToggle(this,'meds')">No</button>
                      <button type="button" class="syn-btn" data-v="yes" onclick="safetyToggle(this,'meds')">Yes</button>
                    </div>
                    <textarea id="safety-meds" class="safety-detail" maxlength="500"
                      placeholder="Please list‚Ä¶" style="display:none;"></textarea>
                  </div>

                  <!-- Q3: Allergies -->
                  <div class="form-group safety-q-wrap">
                    <div class="safety-q-label">3. Any known allergies to wax or beauty products?
                      <span style="color:var(--text-muted);font-weight:400;display:block;font-size:11.5px;margin-top:2px;">Resins, latex, fragrances, oils, creams, etc.</span>
                    </div>
                    <div class="safety-yn" data-q="allergies">
                      <button type="button" class="syn-btn" data-v="no" onclick="safetyToggle(this,'allergies')">No</button>
                      <button type="button" class="syn-btn" data-v="yes" onclick="safetyToggle(this,'allergies')">Yes</button>
                    </div>
                    <textarea id="safety-allergies" class="safety-detail" maxlength="500"
                      placeholder="Please describe your allergy‚Ä¶" style="display:none;"></textarea>
                  </div>

                  <!-- Q4: Pregnant -->
                  <div class="form-group safety-q-wrap">
                    <div class="safety-q-label">4. Are you currently pregnant?</div>
                    <div class="safety-yn" data-q="pregnant">
                      <button type="button" class="syn-btn" data-v="no" onclick="safetyToggle(this,'pregnant')">No</button>
                      <button type="button" class="syn-btn" data-v="yes" onclick="safetyToggle(this,'pregnant')">Yes</button>
                    </div>
                  </div>

                  <!-- Q5: Health conditions -->
                  <div class="form-group safety-q-wrap">
                    <div class="safety-q-label">5. Any health conditions affecting skin, healing, or safety?
                      <span style="color:var(--text-muted);font-weight:400;display:block;font-size:11.5px;margin-top:2px;">Diabetes, varicose veins, immune conditions, recent surgery, etc.</span>
                    </div>
                    <div class="safety-yn" data-q="health">
                      <button type="button" class="syn-btn" data-v="no" onclick="safetyToggle(this,'health')">No</button>
                      <button type="button" class="syn-btn" data-v="yes" onclick="safetyToggle(this,'health')">Yes</button>
                    </div>
                    <textarea id="safety-health" class="safety-detail" maxlength="500"
                      placeholder="Please explain‚Ä¶" style="display:none;"></textarea>
                  </div>

                  <!-- Q6: Environmental exposure -->
                  <div class="form-group safety-q-wrap">
                    <div class="safety-q-label">6. Significant environmental exposure?
                      <span style="color:var(--text-muted);font-weight:400;display:block;font-size:11.5px;margin-top:2px;">Sun, heat, chemicals, frequent water or sweat contact in the area.</span>
                    </div>
                    <div class="safety-yn" data-q="enviro">
                      <button type="button" class="syn-btn" data-v="no" onclick="safetyToggle(this,'enviro')">No</button>
                      <button type="button" class="syn-btn" data-v="yes" onclick="safetyToggle(this,'enviro')">Yes</button>
                    </div>
                    <textarea id="safety-enviro" class="safety-detail" maxlength="300"
                      placeholder="Please describe‚Ä¶" style="display:none;"></textarea>
                  </div>

                  <!-- Q7: Physical factors -->
                  <div class="form-group safety-q-wrap">
                    <div class="safety-q-label">7. Frequent pressure or friction on areas to be waxed?
                      <span style="color:var(--text-muted);font-weight:400;display:block;font-size:11.5px;margin-top:2px;">Due to work, sport, tight clothing, etc.</span>
                    </div>
                    <div class="safety-yn" data-q="physical">
                      <button type="button" class="syn-btn" data-v="no" onclick="safetyToggle(this,'physical')">No</button>
                      <button type="button" class="syn-btn" data-v="yes" onclick="safetyToggle(this,'physical')">Yes</button>
                    </div>
                    <textarea id="safety-physical" class="safety-detail" maxlength="300"
                      placeholder="Please describe‚Ä¶" style="display:none;"></textarea>
                  </div>

                  <!-- Q8: Hair length -->
                  <div class="form-group safety-q-wrap" style="margin-bottom:4px;">
                    <div class="safety-q-label">8. At least 2 weeks of uninterrupted hair growth?
                      <span style="color:var(--text-muted);font-weight:400;display:block;font-size:11.5px;margin-top:2px;">This is required for effective waxing results.</span>
                    </div>
                    <div class="safety-yn" data-q="hair">
                      <button type="button" class="syn-btn" data-v="no" onclick="safetyToggle(this,'hair')">No</button>
                      <button type="button" class="syn-btn" data-v="yes" onclick="safetyToggle(this,'hair')">Yes</button>
                    </div>
                  </div>

                  <!-- Additional info -->
                  <div class="form-group" style="margin-top:10px;">
                    <label for="safety-notes" style="font-size:12.5px;">Anything else we should know? <span style="color:var(--text-muted);font-weight:400;">(optional)</span></label>
                    <textarea id="safety-notes" maxlength="500"
                      placeholder="Additional information‚Ä¶"
                      style="width:100%;padding:11px 14px;background:rgba(0,0,0,0.4);
                             border:1px solid var(--border);border-radius:var(--r-sm);
                             color:var(--text);font-family:inherit;font-size:13px;
                             outline:none;resize:vertical;min-height:56px;"></textarea>
                  </div>
                </div>

              </div>
            </div>
            <!-- Step 4: Review + Payment (two cards, same page) -->
            <div id="step-summary" class="view">
              <div class="section-label">Review booking</div>
              <div class="scroll-area">

                <!-- Card 1: Booking details -->
                <div class="summary-card" style="margin-bottom:10px;">
                  <div id="summary-block"></div>
                </div>

                <!-- Card 2: Pricing -->
                <div class="summary-card" style="margin-bottom:10px;">
                  <div class="fee-row">
                    <span class="fee-label">Services</span>
                    <span class="fee-value" id="sum-services-total">‚Äî</span>
                  </div>
                  <div class="fee-row">
                    <span class="fee-label">Call-out fee</span>
                    <span class="fee-value" id="sum-callout-fee">
                      <span class="fee-calculating"><span class="loader" style="width:11px;height:11px;border-width:1.5px;"></span> Calculating‚Ä¶</span>
                    </span>
                  </div>
                  <div class="summary-divider"></div>
                  <div class="summary-grand-total">
                    <span>Total</span>
                    <span id="sum-total">‚Äî</span>
                  </div>
                  <div class="deposit-box">
                    <div>
                      <div class="deposit-box-label">Deposit due now (50%)</div>
                      <div class="balance-note" id="sum-balance-note">Balance due on the day</div>
                    </div>
                    <div class="deposit-box-amount" id="sum-deposit">‚Äî</div>
                  </div>
                </div>

                <div style="text-align:center;padding:10px 4px 2px;">
                  <p style="margin:0;font-size:12px;color:var(--text-muted);line-height:1.6;">
                    By making payment you agree to our
                    <a href="/policy.html?terms" target="_blank"
                       style="color:#000000;text-decoration:underline;font-weight:600;white-space:nowrap;">
                      Terms &amp; Conditions
                    </a>
                  </p>
                </div>
              </div>
            </div>

            <!-- Success / Confirmation screen (shown after payment verified) -->
            <div class="success-view" id="success-view">
              <div class="success-icon" id="success-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
              <div class="success-title" id="success-title">You're booked! üéâ</div>
              <div class="success-totals" id="success-totals"></div>
            </div>
          </div>
        </div>
        <div class="actions" id="actions-bar">
          <button class="btn-outline" id="btn-back" style="display:none;" onclick="prevStep()">Back</button>
          <button class="btn-primary" id="btn-next" onclick="nextStep()" disabled>Next</button>
        </div>
      </div>
    </div>
    <div id="toast" class="toast"></div>
    <script>
      // PhenomeBeauty Booking ‚Äî v3.0
      // ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let currentStep      = 1;
      let services         = [];
      let selectedServices = [];
      let selectedDate     = '';
      let selectedTime     = '';
      let activeCategory   = null;
      let appConfig        = {};
      let lastFeeData      = { fee: 0, oneWayKm: 0, roundTripKm: 0 };
      let addressConfirmed = false;
      let addrDebounceTimer = null;

      // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      window.onload = () => {
        // Handle Yoco redirect back
        const params = new URLSearchParams(window.location.search);
        const pStatus = params.get('payment');
        const pRef    = params.get('ref');
        if (pStatus) {
          window.history.replaceState({}, '', window.location.pathname);
          if (pStatus === 'success' && pRef) {
            fetch('/api/check-payment?ref=' + encodeURIComponent(pRef))
              .then(r => r.json())
              .then(data => showDepositThankYou(data))
              .catch(() => showDepositThankYou(null));
          } else if (pStatus === 'balance-success' && pRef) {
            fetch('/api/check-payment?ref=' + encodeURIComponent(pRef))
              .then(r => r.json())
              .then(data => showBalanceThankYou(data))
              .catch(() => showBalanceThankYou(null));
          } else if (pStatus === 'cancelled' || pStatus === 'balance-cancelled') {
            showBanner('Payment cancelled ‚Äî your slot is still held. You can pay anytime.', false);
          }
        }
        // Load config then boot
        fetch('/api?action=getConfig')
          .then(r => r.json())
          .then(cfg => { appConfig = cfg || {}; })
          .catch(() => {})
          .finally(() => { loadServices(); calInit(); updateStepUI(); });
      };

      // ‚îÄ‚îÄ THANK YOU SCREENS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function hideBookingUI() {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('actions-bar').style.display = 'none';
        document.getElementById('step-label').textContent = '';
        for (let i = 1; i <= 4; i++)
          document.getElementById('step-bar-' + i).style.width = '100%';
        // Reset success icon/title to default
        document.getElementById('success-icon').style.display = '';
        document.getElementById('success-title').textContent = "You're booked! üéâ";
      }

      function showDepositThankYou(data) {
        hideBookingUI();
        document.getElementById('view-title').textContent = '‚ú® You\'re Booked!';
        document.getElementById('success-title').textContent = "You're booked! üéâ";
        const firstName = data && data.name ? data.name.split(' ')[0] : 'Beautiful';
        document.getElementById('success-totals').innerHTML = `
          <div style="text-align:center;padding:4px 0 18px;">
            <div style="font-size:44px;margin-bottom:10px;">üå∏</div>
            <p style="margin:0 0 18px;font-size:13.5px;color:rgba(0,0,0,0.6);line-height:1.7;">
              Your deposit is confirmed and your stylist<br>is looking forward to pampering you. üíï
            </p>
          </div>
          ${data ? `
          <div style="background:rgba(0,0,0,0.08);border:1px solid rgba(0,0,0,0.08);border-radius:16px;padding:16px 18px;margin-bottom:14px;">
            <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:8px;">
              <span style="color:rgba(0,0,0,0.5);">üìÖ Date</span>
              <strong style="color:#000000;">${escHtml(fmtDateDisplay(data.date))}</strong>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:8px;">
              <span style="color:rgba(0,0,0,0.5);">üïê Time</span>
              <strong style="color:#000000;">${escHtml(data.time||'')}</strong>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:13px;">
              <span style="color:rgba(0,0,0,0.5);">üíÖ Service</span>
              <span style="text-align:right;max-width:55%;font-size:12px;">${escHtml(data.services||'')}</span>
            </div>
          </div>
          <div style="background:rgba(0,0,0,0.07);border:1px solid rgba(0,0,0,0.07);border-radius:16px;padding:16px 18px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px;">
              <span style="color:rgba(0,0,0,0.5);">Deposit Paid ‚úÖ</span>
              <strong style="color:#000000;">R${escHtml(String(data.deposit||'0'))}</strong>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:13px;">
              <span style="color:rgba(0,0,0,0.5);">Balance (after service)</span>
              <strong style="color:#000000;">R${escHtml(String(data.balance||'0'))}</strong>
            </div>
          </div>
          <p style="font-size:12px;color:rgba(0,0,0,0.16);text-align:center;margin:0 0 4px;">
            A confirmation email is on its way üìß
          </p>
          <p style="font-size:10.5px;color:rgba(0,0,0,0.2);text-align:center;margin:0;">
            Ref: ${escHtml(data.bookingId||'')}
          </p>` : `
          <p style="font-size:13px;color:rgba(0,0,0,0.45);text-align:center;">
            A confirmation email is on its way üìß
          </p>`}
        `;
        document.getElementById('success-view').classList.add('active');
      }

      function showBalanceThankYou(data) {
        hideBookingUI();
        // Hide the generic icon/title ‚Äî this screen has its own header
        document.getElementById('success-icon').style.display = 'none';
        document.getElementById('success-title').style.display = 'none';

        const firstName  = data && data.name ? data.name.split(' ')[0] : 'Beautiful';
        const appBase    = (data && data.appBase) ? data.appBase : window.location.origin;
        const isPaid     = data && data.balanceStatus === 'Paid';

        document.getElementById('view-title').textContent = isPaid ? 'üå∏ Thank You!' : 'üí≥ Payment Received';

        document.getElementById('success-totals').innerHTML = isPaid ? `
          <div style="text-align:center;padding:8px 0 18px;">
            <div style="font-size:48px;margin-bottom:10px;">üíÖ‚ú®</div>
            <h2 style="margin:0 0 8px;font-size:19px;font-weight:700;color:#f8fafc;">
              Thank you, ${escHtml(firstName)}!
            </h2>
            <p style="margin:0 0 20px;font-size:13px;color:rgba(0,0,0,0.6);line-height:1.7;">
              Your full payment is in and we are so grateful<br>for your trust in PhenomeBeauty. üå∏
            </p>
          </div>
          <div style="background:rgba(0,0,0,0.07);border:1px solid rgba(0,0,0,0.07);border-radius:16px;padding:16px 18px;margin-bottom:18px;text-align:center;">
            <div style="font-size:12px;color:rgba(0,0,0,0.45);margin-bottom:4px;">Total Paid</div>
            <div style="font-size:28px;font-weight:700;color:#000000;">R${escHtml(String(data.total||'0'))} ‚úÖ</div>
          </div>
          <div style="background:rgba(0,0,0,0.08);border:1px solid rgba(0,0,0,0.08);border-radius:16px;padding:18px;margin-bottom:16px;text-align:center;">
            <p style="margin:0 0 14px;font-size:13px;color:rgba(0,0,0,0.55);line-height:1.7;">
              Beauty is a lifestyle, not a luxury.<br>We'd love to see you again soon üíï
            </p>
            <a href="${escHtml(appBase)}" style="display:inline-block;background:linear-gradient(135deg,#000000,#000000);color:#ffffff;padding:12px 24px;border-radius:12px;font-size:13px;font-weight:700;text-decoration:none;">
              Book Your Next Appointment ‚Üí
            </a>
          </div>
          <p style="font-size:11.5px;color:rgba(0,0,0,0.16);text-align:center;margin:0;">
            A receipt has been sent to your email üìß
          </p>` : `
          <div style="text-align:center;padding:8px 0 18px;">
            <div style="font-size:48px;margin-bottom:10px;">üí≥</div>
            <h2 style="margin:0 0 8px;font-size:19px;font-weight:700;color:#f8fafc;">
              Payment is being processed
            </h2>
            <p style="margin:0 0 20px;font-size:13px;color:rgba(0,0,0,0.6);line-height:1.7;">
              Thank you, ${escHtml(firstName)}! Your payment is on its way through.<br>
              We'll send you a confirmation email shortly. üíï
            </p>
          </div>
          <div style="background:rgba(0,0,0,0.08);border:1px solid rgba(0,0,0,0.08);border-radius:16px;padding:16px 18px;margin-bottom:16px;text-align:center;font-size:13px;color:rgba(0,0,0,0.55);">
            ‚è≥ Payments can take a moment to confirm ‚Äî please don't pay again.
          </div>`;

        document.getElementById('success-view').classList.add('active');
      }

      function fmtDateDisplay(ds) {
        if (!ds) return '';
        const [y,m,d] = ds.split('-').map(Number);
        const dt = new Date(y, m-1, d);
        const D = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        const M = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        return D[dt.getDay()] + ', ' + d + ' ' + M[m-1] + ' ' + y;
      }

      // ‚îÄ‚îÄ TOAST / BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function showToast(msg, isError) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = 'toast show' + (isError ? ' error' : '');
        clearTimeout(t._t);
        t._t = setTimeout(() => t.classList.remove('show'), 3500);
      }

      function showBanner(msg, success) {
        const b = document.createElement('div');
        b.style.cssText = 'position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:99999;' +
          'max-width:92vw;padding:13px 18px;border-radius:14px;font-size:13px;font-weight:600;' +
          'text-align:center;box-shadow:0 16px 40px rgba(0,0,0,.7);cursor:pointer;' +
          (success ? 'background:linear-gradient(135deg,#000000,#000000);color:#ffffff;'
                   : 'background:linear-gradient(135deg,#b45309,#92400e);color:#fef3c7;');
        b.textContent = msg;
        document.body.appendChild(b);
        setTimeout(() => b.remove(), 7000);
        b.onclick = () => b.remove();
      }

      // ‚îÄ‚îÄ SERVICES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function loadServices() {
        fetch('/api?action=getServices')
          .then(r => r.json())
          .then(data => { services = Array.isArray(data) ? data : []; renderServices(); })
          .catch(() => showToast('Unable to load services ‚Äî please refresh', true));
      }

      function renderServices() {
        const grouped = {};
        services.forEach(s => {
          const c = s.category || 'Other';
          if (!grouped[c]) grouped[c] = [];
          grouped[c].push(s);
        });
        const cats = Object.keys(grouped);
        if (!activeCategory && cats.length) activeCategory = cats[0];

        // Chips
        const chips = document.getElementById('category-chips');
        chips.innerHTML = cats.map(c =>
          `<button type="button" class="chip ${c === activeCategory ? 'active' : ''}" data-cat="${escHtml(c)}">${escHtml(c)}</button>`
        ).join('');
        chips.querySelectorAll('.chip').forEach(btn =>
          btn.addEventListener('click', () => { activeCategory = btn.dataset.cat; renderServices(); }));

        // Service cards
        const list = grouped[activeCategory] || [];
        const el   = document.getElementById('services-list');
        el.innerHTML = list.map(s => {
          const sel = selectedServices.some(x => String(x.id) === String(s.id));
          return `<div class="service-card ${sel ? 'selected' : ''}" data-id="${escHtml(String(s.id))}">
            <div class="service-main">
              <div class="service-header">
                <div class="service-name">${escHtml(s.name)}</div>
                <div class="service-price">R${Number(s.price).toFixed(0)}</div>
              </div>
              <div class="service-meta">${escHtml(s.description||'')} ¬∑ ${s.duration||0} min</div>
            </div>
            <div class="check-circle">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
          </div>`;
        }).join('');
        el.querySelectorAll('.service-card').forEach(card =>
          card.addEventListener('click', () => {
            const id = String(card.dataset.id);
            const svc = services.find(x => String(x.id) === id);
            if (!svc) return;
            const idx = selectedServices.findIndex(x => String(x.id) === id);
            if (idx > -1) selectedServices.splice(idx, 1);
            else          selectedServices.push(svc);
            renderServices();
          }));

        renderCart();
        updateNextBtn();
      }

      // ‚îÄ‚îÄ CART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function renderCart() {
        const bar = document.getElementById('cart-bar');
        if (!selectedServices.length) { bar.classList.remove('visible'); return; }
        bar.classList.add('visible');
        const total    = selectedServices.reduce((a, s) => a + Number(s.price), 0);
        const duration = selectedServices.reduce((a, s) => a + (Number(s.duration)||0), 0);
        document.getElementById('cart-total-price').textContent = 'R' + total.toFixed(0);
        const cartList = document.getElementById('cart-items-list');
        cartList.innerHTML = selectedServices.map(s =>
          `<div class="cart-item" data-id="${escHtml(String(s.id))}">
            <span class="cart-item-name">${escHtml(s.name)}</span>
            <span class="cart-item-price">R${Number(s.price).toFixed(0)}</span>
            <span class="cart-remove">‚úï</span>
          </div>`
        ).join('');
        cartList.querySelectorAll('.cart-remove').forEach(btn =>
          btn.addEventListener('click', e => {
            e.stopPropagation();
            const id = String(btn.closest('.cart-item').dataset.id);
            const idx = selectedServices.findIndex(x => String(x.id) === id);
            if (idx > -1) { selectedServices.splice(idx, 1); renderServices(); }
          }));
        document.getElementById('cart-duration').textContent =
          `${selectedServices.length} service${selectedServices.length > 1 ? 's' : ''} ¬∑ ${duration} min total`;
      }

      // ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const monthCache = {};
      let calYear, calMonth;

      function calInit() {
        const now = new Date();
        calYear  = now.getFullYear();
        calMonth = now.getMonth(); // 0-based
        document.getElementById('cal-prev').addEventListener('click', () => {
          const now2 = new Date(); const cy = now2.getFullYear(); const cm = now2.getMonth();
          if (calYear < cy || (calYear === cy && calMonth <= cm)) return;
          calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; }
          calRender();
        });
        document.getElementById('cal-next').addEventListener('click', () => {
          calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; }
          calRender();
        });
        calRender();
      }

      function calPad(n) { return String(n).padStart(2,'0'); }
      function calKey()  { return `${calYear}-${calPad(calMonth+1)}`; }

      function calRender() {
        const now = new Date();
        const isPast = calYear < now.getFullYear() ||
                       (calYear === now.getFullYear() && calMonth < now.getMonth());
        document.getElementById('cal-prev').classList.toggle('disabled', isPast);
        const MONTHS = ['January','February','March','April','May','June',
                        'July','August','September','October','November','December'];
        document.getElementById('cal-month-label').textContent = MONTHS[calMonth] + ' ' + calYear;
        const key = calKey();
        if (monthCache[key] && monthCache[key].loaded) {
          calDrawDays();
        } else {
          if (!monthCache[key]) monthCache[key] = { loaded: false, slots: {} };
          calDrawDays('loading');
          fetch('/api?action=getMonthAvailability&month=' + encodeURIComponent(key))
            .then(r => r.json())
            .then(slots => {
              monthCache[key] = { loaded: true, slots: slots || {} };
              if (calKey() === key) calDrawDays();
            })
            .catch(() => { monthCache[key] = { loaded: true, slots: {} }; calDrawDays(); });
        }
      }

      function calDrawDays(state) {
        const today = new Date(); today.setHours(0,0,0,0);
        const key   = calKey();
        const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
        const firstDow    = new Date(calYear, calMonth, 1).getDay();
        let html = '';
        for (let i = 0; i < firstDow; i++) html += '<div class="cal-day empty"></div>';
        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `${calYear}-${calPad(calMonth+1)}-${calPad(d)}`;
          const dt      = new Date(calYear, calMonth, d);
          const isPast  = dt < today;
          const isToday = dt.getTime() === today.getTime();
          const isSel   = dateStr === selectedDate;
          let cls = 'cal-day', dot = '';
          if (isSel)       cls += ' selected';
          else if (isPast) cls += ' past';
          else if (state === 'loading') cls += ' loading-month';
          else {
            const times = (monthCache[key] && monthCache[key].slots[dateStr]) || [];
            if (times.length) { cls += ' has-slots'; dot = '<div class="cal-day-dot"></div>'; }
            else              cls += ' no-slots';
          }
          if (isToday && !isSel && !isPast) cls += ' today';
          html += `<div class="${cls}" data-date="${dateStr}">${d}${dot}</div>`;
        }
        const container = document.getElementById('cal-days');
        container.innerHTML = html;
        container.querySelectorAll('.cal-day.has-slots, .cal-day.selected').forEach(el =>
          el.addEventListener('click', () => {
            if (selectedDate === el.dataset.date) return;
            selectedDate = el.dataset.date;
            selectedTime = '';
            calDrawDays();
            const times = (monthCache[calKey()] && monthCache[calKey()].slots[selectedDate]) || [];
            renderTimeSlots(times);
            updateNextBtn();
          }));
      }

      function renderTimeSlots(times) {
        const section = document.getElementById('time-section');
        const grid    = document.getElementById('time-grid');
        const label   = document.getElementById('time-section-label');
        if (!times || !times.length) { section.style.display = 'none'; return; }
        const dt = new Date(selectedDate + 'T00:00:00');
        const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        const MTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        label.textContent = DAYS[dt.getDay()] + ', ' + dt.getDate() + ' ' + MTHS[dt.getMonth()];
        grid.innerHTML = times.map(t =>
          `<div class="time-slot ${selectedTime === t ? 'selected' : ''}" data-time="${escHtml(t)}">${escHtml(t)}</div>`
        ).join('');
        grid.querySelectorAll('.time-slot').forEach(el =>
          el.addEventListener('click', () => {
            selectedTime = el.dataset.time;
            grid.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
            el.classList.add('selected');
            updateNextBtn();
          }));
        section.style.display = 'block';
      }

      // ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function nextStep() {
        if (currentStep === 3 && (!validateDetails() || !safetyComplete())) return; // FIX #1
        if (currentStep === 4) { submitBooking(); return; }
        currentStep++;
        updateStepUI();
      }

      function prevStep() {
        if (currentStep <= 1) return;
        currentStep--;
        updateStepUI();
      }

      function updateStepUI() {
        const views  = ['services','datetime','details','summary'];
        const titles = ['Choose Services','Select Date & Time','Your Details','Review Booking'];
        const labels = ['Step 1 of 4 ¬∑ Services','Step 2 of 4 ¬∑ Date & Time',
                        'Step 3 of 4 ¬∑ Details','Step 4 of 4 ¬∑ Review'];

        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('step-' + views[currentStep - 1]).classList.add('active');
        document.getElementById('view-title').textContent  = titles[currentStep - 1];
        document.getElementById('step-label').textContent  = labels[currentStep - 1];
        document.getElementById('btn-back').style.display  = currentStep === 1 ? 'none' : 'block';

        // *** THE BUTTON ‚Äî step 4 = "Proceed to Payment" ***
        document.getElementById('btn-next').textContent =
          currentStep === 4 ? 'Proceed to Payment' : 'Next';

        for (let i = 1; i <= 4; i++)
          document.getElementById('step-bar-' + i).style.width = i <= currentStep ? '100%' : '0';

        if (currentStep === 2) {
          calDrawDays(); // FIX #5: restore selected date highlight on back navigation
          if (selectedDate) {
            const _k = calKey();
            if (monthCache[_k] && monthCache[_k].slots && monthCache[_k].slots[selectedDate]) {
              renderTimeSlots(monthCache[_k].slots[selectedDate]);
            }
          }
          const k = calKey();
          if (!monthCache[k] || !monthCache[k].loaded) calRender();
        }
        if (currentStep === 3) initPlacesAutocomplete();
        if (currentStep === 4) renderSummary();
        updateNextBtn();
      }

      const SAFETY_KEYS = ['skin','meds','allergies','pregnant','health','enviro','physical','hair'];
      function safetyComplete() {
        if (divaType !== 'new') return true;
        return SAFETY_KEYS.every(k => safetyAnswers[k] === 'yes' || safetyAnswers[k] === 'no');
      }

      function updateNextBtn() {
        const btn = document.getElementById('btn-next');
        if (currentStep === 1) btn.disabled = selectedServices.length === 0;
        else if (currentStep === 2) btn.disabled = !selectedDate || !selectedTime;
        else if (currentStep === 3) {
          const name  = document.getElementById('client-name').value.trim();
          const phone = document.getElementById('client-phone').value.replace(/\D/g,'');
          const email = document.getElementById('client-email').value.trim();
          const addr  = document.getElementById('client-address').value.trim();
          btn.disabled = name.length < 2 || !/^0\d{9}$/.test(phone) ||
                         !/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(email) || addr.length < 5 || !safetyComplete(); // FIX #1c + #6b
        } else if (currentStep === 4) {
          btn.disabled = false;
        } else {
          btn.disabled = false;
        }
      }

      // ‚îÄ‚îÄ PHONE / EMAIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function formatPhone(input) {
        let d = input.value.replace(/\D/g,'').slice(0,10);
        input.value = d.length > 6 ? d.slice(0,3)+' '+d.slice(3,6)+' '+d.slice(6)
                    : d.length > 3 ? d.slice(0,3)+' '+d.slice(3) : d;
        const ok = /^0\d{9}$/.test(d);
        input.classList.toggle('input-valid', ok);
        input.classList.toggle('input-error', d.length === 10 && !ok);
        updateNextBtn();
      }

      function validateEmail(input) {
        const v = input.value.trim();
        const ok = v.length > 4 && /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v);
        input.classList.toggle('input-valid', ok);
        input.classList.toggle('input-error', v.includes('@') && v.split('@')[1]?.includes('.') && !ok);
        updateNextBtn();
      }

      // ‚îÄ‚îÄ ADDRESS AUTOCOMPLETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function initPlacesAutocomplete() {
        const key = appConfig.google_maps_api_key || appConfig.mapsApiKey;
        const input    = document.getElementById('client-address');
        const dropdown = document.getElementById('addr-suggestions');
        if (!key || !input || !dropdown || input.dataset.acAttached) return;
        input.dataset.acAttached = '1';
        input.addEventListener('input', () => {
          addressConfirmed = false;
          input.classList.remove('input-valid','input-error');
          updateNextBtn();
          clearTimeout(addrDebounceTimer);
          const q = input.value.trim();
          if (q.length < 3) { closeDropdown(); return; }
          addrDebounceTimer = setTimeout(async () => {
            try {
              const r = await fetch('https://places.googleapis.com/v1/places:autocomplete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Goog-Api-Key': key },
                body: JSON.stringify({ input: q, includedRegionCodes: ['za'], languageCode: 'en' }),
              });
              const data = await r.json();
              const sugs = data.suggestions || [];
              if (!sugs.length) { closeDropdown(); return; }
              dropdown.innerHTML = sugs.slice(0,5).map(s => {
                const p    = s.placePrediction;
                const main = p?.structuredFormat?.mainText?.text || p?.text?.text || '';
                const sec  = p?.structuredFormat?.secondaryText?.text || '';
                const full = p?.text?.text || main;
                return `<div class="addr-suggestion-item" data-full="${escHtml(full)}">
                  <div class="addr-suggestion-main">${escHtml(main)}</div>
                  ${sec ? `<div class="addr-suggestion-sec">${escHtml(sec)}</div>` : ''}
                </div>`;
              }).join('');
              dropdown.querySelectorAll('.addr-suggestion-item').forEach(item => {
                item.addEventListener('mousedown', e => e.preventDefault());
                item.addEventListener('click', () => {
                  input.value = item.dataset.full;
                  addressConfirmed = true;
                  input.classList.add('input-valid');
                  input.classList.remove('input-error');
                  closeDropdown(); updateNextBtn();
                });
              });
              dropdown.classList.add('open');
            } catch(e) { closeDropdown(); }
          }, 220);
        });
        input.addEventListener('keydown', e => {
          const items  = [...dropdown.querySelectorAll('.addr-suggestion-item')];
          const active = dropdown.querySelector('.addr-suggestion-item.active');
          let idx = items.indexOf(active);
          if (e.key === 'ArrowDown') { e.preventDefault(); idx=(idx+1)%items.length; }
          else if (e.key === 'ArrowUp') { e.preventDefault(); idx=(idx-1+items.length)%items.length; }
          else if (e.key === 'Enter' && active) { e.preventDefault(); active.click(); return; }
          else if (e.key === 'Escape') { closeDropdown(); return; }
          items.forEach(i=>i.classList.remove('active')); items[idx]?.classList.add('active');
        });
        document.addEventListener('click', e => {
          if (!input.contains(e.target) && !dropdown.contains(e.target)) closeDropdown();
        });
      }

      function closeDropdown() {
        const d = document.getElementById('addr-suggestions');
        if (d) { d.classList.remove('open'); d.innerHTML=''; }
      }

      // ‚îÄ‚îÄ VALIDATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function validateDetails() {
        const name  = document.getElementById('client-name').value.trim();
        const phone = document.getElementById('client-phone').value.replace(/\D/g,'');
        const email = document.getElementById('client-email').value.trim();
        const addr  = document.getElementById('client-address').value.trim();
        if (name.length < 2)                       { showToast('Please enter your full name', true);        return false; }
        if (!/^0\d{9}$/.test(phone))               { showToast('Enter a valid 10-digit SA phone number', true); return false; }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(email)) { showToast('Enter a valid email address', true); return false; } // FIX #6
        if (addr.length < 5)                       { showToast('Please enter your full address', true);     return false; }
        return true;
      }

      // ‚îÄ‚îÄ SUMMARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function fmtDate(ds) {
        if (!ds) return '‚Äî';
        const [y,m,d] = ds.split('-').map(Number);
        const dt = new Date(y, m-1, d);
        const D = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        const M = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        return D[dt.getDay()] + ', ' + d + ' ' + M[m-1] + ' ' + y;
      }

      function renderSummary() {
        const sTotal   = selectedServices.reduce((a, s) => a + Number(s.price), 0);
        const sDur     = selectedServices.reduce((a, s) => a + (Number(s.duration)||0), 0);
        const name     = document.getElementById('client-name').value.trim();
        const rawPhone = document.getElementById('client-phone').value.replace(/\D/g,'');
        const phone    = rawPhone.replace(/(\d{3})(\d{3})(\d{4})/, '$1 $2 $3');
        const address  = document.getElementById('client-address').value.trim();

        document.getElementById('summary-block').innerHTML = `
          <div class="summary-row"><span class="summary-label">Date</span><span class="summary-value">${fmtDate(selectedDate)}</span></div>
          <div class="summary-row"><span class="summary-label">Time</span><span class="summary-value">${escHtml(selectedTime)||'‚Äî'}</span></div>
          <div class="summary-row"><span class="summary-label">Services (${selectedServices.length})</span>
            <span class="summary-value" style="font-size:11.5px;">${selectedServices.map(s=>escHtml(s.name)).join(', ')}</span></div>
          <div class="summary-row"><span class="summary-label">Duration</span><span class="summary-value">${sDur} min</span></div>
          <div class="summary-divider"></div>
          <div class="summary-row"><span class="summary-label">Client</span><span class="summary-value">${escHtml(name)}</span></div>
          <div class="summary-row"><span class="summary-label">Phone</span><span class="summary-value">${escHtml(phone)}</span></div>
          <div class="summary-row"><span class="summary-label">Address</span><span class="summary-value" style="font-size:11.5px;">${escHtml(address)}</span></div>`;

        document.getElementById('sum-services-total').textContent = 'R' + sTotal.toFixed(2);
        document.getElementById('sum-callout-fee').innerHTML =
          '<span class="fee-calculating"><span class="loader" style="width:11px;height:11px;border-width:1.5px;"></span> Calculating‚Ä¶</span>';
        document.getElementById('sum-total').textContent   = '‚Äî';
        document.getElementById('sum-deposit').textContent = '‚Äî';
        document.getElementById('sum-balance-note').textContent = 'Balance due on the day';
        document.getElementById('btn-next').disabled = true;

        fetch('/api?action=getCallOutFee&address=' + encodeURIComponent(address))
          .then(r => r.json())
          .then(result => {
            const pct     = parseFloat(appConfig.deposit_percent || 50) / 100;
            const fee     = typeof result.fee === 'number' ? result.fee : 0;
            const total   = sTotal + fee;
            const deposit = Math.round(total * pct * 100) / 100;
            const balance = Math.round((total - deposit) * 100) / 100;
            lastFeeData   = { fee, oneWayKm: result.oneWayKm||0, roundTripKm: result.roundTripKm||0 };

            if (fee === 0 && result.error) {
              document.getElementById('sum-callout-fee').innerHTML =
                'R0.00 <span style="font-size:10px;color:rgba(248,113,113,.9);" title="'+escHtml(result.error)+'">‚ö†</span>';
            } else {
              document.getElementById('sum-callout-fee').textContent = 'R' + fee.toFixed(2);
            }
            document.getElementById('sum-total').textContent        = 'R' + total.toFixed(2);
            document.getElementById('sum-deposit').textContent      = 'R' + deposit.toFixed(2);
            document.getElementById('sum-balance-note').textContent = 'Balance on the day: R' + balance.toFixed(2);
            document.getElementById('btn-next').disabled = false;
          })
          .catch(() => {
            const pct = parseFloat(appConfig.deposit_percent || 50) / 100;
            const dep = Math.round(sTotal * pct * 100) / 100;
            document.getElementById('sum-callout-fee').innerHTML =
              'R0.00 <span style="font-size:10px;color:rgba(248,113,113,.9);">‚ö†</span>';
            document.getElementById('sum-total').textContent        = 'R' + sTotal.toFixed(2);
            document.getElementById('sum-deposit').textContent      = 'R' + dep.toFixed(2);
            document.getElementById('sum-balance-note').textContent = 'Balance on the day: R' + (sTotal - dep).toFixed(2);
            document.getElementById('btn-next').disabled = false;
          });
      }

      // ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 1. Save booking to DB (slot blocked immediately as "Pending Payment")
      // 2. Redirect straight to Yoco ‚Äî no intermediate screen
      // 3. Yoco redirects back ‚Üí webhook confirms ‚Üí status ‚Üí Confirmed
      // ‚îÄ‚îÄ SAFETY YES/NO TOGGLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const safetyAnswers = {}; // tracks current answer per question key
      function safetyToggle(btn, key) {
        const val = btn.dataset.v;
        safetyAnswers[key] = val;
        // Update button styles within same .safety-yn group
        btn.closest('.safety-yn').querySelectorAll('.syn-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        // Show/hide detail textarea
        const detail = document.getElementById('safety-' + key);
        if (detail) {
          detail.style.display = val === 'yes' ? 'block' : 'none';
          if (val === 'no') detail.value = '';
        }
        updateNextBtn(); // FIX #2
      }
      let divaType = 'existing'; // default

      function toggleDiva(type) {
        divaType = type;
        const safetySection = document.getElementById('safety-section');
        const btnExisting   = document.getElementById('diva-existing');
        const btnNew        = document.getElementById('diva-new');
        if (type === 'new') {
          safetySection.style.display = 'block';
          btnNew.style.background      = 'rgba(0,0,0,0.12)';
          btnNew.style.color           = '#000000';
          btnNew.style.borderColor     = '#000000';
          btnExisting.style.background = 'rgba(255,255,255,0.05)';
          btnExisting.style.color      = 'var(--text-muted)';
          btnExisting.style.borderColor= 'var(--border)';
        } else {
          safetySection.style.display = 'none';
          // Reset all safety answers when switching to existing
          Object.keys(safetyAnswers).forEach(k => delete safetyAnswers[k]);
          document.querySelectorAll('.syn-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.safety-detail').forEach(t => { t.style.display='none'; t.value=''; });
          btnExisting.style.background = 'rgba(0,0,0,0.08)';
          btnExisting.style.color      = '#000000';
          btnExisting.style.borderColor= '#000000';
          btnNew.style.background      = 'rgba(255,255,255,0.05)';
          btnNew.style.color           = 'var(--text-muted)';
          btnNew.style.borderColor     = 'var(--border)';
        }
        updateNextBtn(); // FIX #3
      }

      function submitBooking() {
        const btn = document.getElementById('btn-next');
        btn.disabled = true;
        btn.innerHTML = '<span class="loader"></span> Saving‚Ä¶';

        const sTotal  = selectedServices.reduce((a, s) => a + Number(s.price), 0);
        const pct     = parseFloat(appConfig.deposit_percent || 50) / 100;
        const fee     = lastFeeData.fee || 0;
        const total   = Math.round((sTotal + fee) * 100) / 100;
        const deposit = Math.round(total * pct * 100) / 100;
        const balance = Math.round((total - deposit) * 100) / 100;

        const safety = divaType === 'new' ? {
          skinConditions:   safetyAnswers.skin === 'yes' ? (document.getElementById('safety-skin')?.value    || '').trim().slice(0, 500) : (safetyAnswers.skin === 'no' ? 'None' : ''),
          medications:      safetyAnswers.meds === 'yes' ? (document.getElementById('safety-meds')?.value    || '').trim().slice(0, 500) : (safetyAnswers.meds === 'no' ? 'None' : ''),
          allergies:        safetyAnswers.allergies === 'yes' ? (document.getElementById('safety-allergies')?.value || '').trim().slice(0, 500) : (safetyAnswers.allergies === 'no' ? 'None' : ''),
          pregnant:         safetyAnswers.pregnant === 'yes',
          healthConditions: safetyAnswers.health === 'yes' ? (document.getElementById('safety-health')?.value  || '').trim().slice(0, 500) : (safetyAnswers.health === 'no' ? 'None' : ''),
          environmental:    safetyAnswers.enviro === 'yes' ? (document.getElementById('safety-enviro')?.value  || '').trim().slice(0, 300) : (safetyAnswers.enviro === 'no' ? 'None' : ''),
          physical:         safetyAnswers.physical === 'yes' ? (document.getElementById('safety-physical')?.value || '').trim().slice(0, 300) : (safetyAnswers.physical === 'no' ? 'None' : ''),
          hairLengthOk:     safetyAnswers.hair === 'yes',
          additionalInfo:   (document.getElementById('safety-notes')?.value || '').trim().slice(0, 500),
        } : null;

        const body = {
          services:      selectedServices,
          date:          selectedDate,
          time:          selectedTime,
          name:          document.getElementById('client-name').value.trim().slice(0, 80),
          phone:         document.getElementById('client-phone').value.replace(/\D/g,'').slice(0, 15),
          email:         document.getElementById('client-email').value.trim().slice(0, 120),
          address:       document.getElementById('client-address').value.trim().slice(0, 200),
          source:        document.getElementById('client-source').value || '',
          divaType,
          safety,
          policyAgreed:  true,
          servicesTotal: sTotal,
          callOutFee:    fee,
          totalAmount:   total,
          depositAmount: deposit,
          balanceDue:    balance,
          oneWayKm:      lastFeeData.oneWayKm,
          roundTripKm:   lastFeeData.roundTripKm,
        };

        fetch('/api/book', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) })
          .then(r => r.json())
          .then(result => {
            if (!result || !result.success) {
              showToast((result && result.error) || 'Booking failed ‚Äî please try again', true);
              btn.disabled = false;
              btn.textContent = 'Proceed to Payment';
              return;
            }
            if (result.paymentUrl) {
              btn.innerHTML = '<span class="loader"></span> Redirecting to payment‚Ä¶';
              window.location.href = result.paymentUrl;
            } else {
              btn.style.display = 'none';
              document.getElementById('btn-back').style.display = 'none';
              // FIX #4: no paymentUrl returned ‚Äî show proper confirmation screen
              showDepositThankYou({
                bookingId: result.bookingId || '',
                name:      document.getElementById('client-name').value.trim(),
                date:      selectedDate,
                time:      selectedTime,
                services:  selectedServices.map(s => s.name).join(', '),
                deposit:   String(result.depositAmount || '0'),
                balance:   String(result.balanceDue    || '0'),
              });
            }
          })
          .catch(() => {
            showToast('Network error ‚Äî please try again', true);
            btn.disabled = false;
            btn.textContent = 'Proceed to Payment';
          });
      }

      // ‚îÄ‚îÄ SUCCESS SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function showSuccessScreen(data) { showDepositThankYou(data); }

      // ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function escHtml(s) {
        return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')
          .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
      }
    </script>
  </body>
</html>
