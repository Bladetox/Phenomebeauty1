<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PhenomeBeauty â€” Book Your Session</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Jost:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/framer-motion@10/dist/framer-motion.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; background: #020207; min-height: 100vh; overflow-x: hidden; }

    /* â•â•â• DEEP AMBIENT CANVAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .bg-canvas {
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background:
        /* Primary top-left white orb */
        radial-gradient(ellipse 80% 60% at 10%  -5%, rgba(255,255,255,0.095) 0%, rgba(255,255,255,0.020) 50%, transparent 100%),
        /* Secondary top-right */
        radial-gradient(ellipse 65% 50% at 92%   0%, rgba(255,255,255,0.065) 0%, rgba(255,255,255,0.010) 50%, transparent 100%),
        /* Subtle centre-bottom glow */
        radial-gradient(ellipse 55% 45% at 50% 110%, rgba(255,255,255,0.040) 0%, transparent 100%),
        /* Deep corner accents */
        radial-gradient(ellipse 40% 38% at  2% 100%, rgba(255,255,255,0.052) 0%, transparent 100%),
        radial-gradient(ellipse 40% 38% at 98%  98%, rgba(255,255,255,0.042) 0%, transparent 100%),
        /* Base â€“ true near-black */
        #020207;
    }
    /* Film-grain texture */
    .bg-canvas::after {
      content: '';
      position: absolute; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
      background-size: 200px 200px;
      opacity: 0.038;
      mix-blend-mode: screen;
    }

    /* â•â•â• OUTER GLASS SHELL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .glass-shell {
      /* Multi-layer glass gradient */
      background:
        linear-gradient(160deg,
          rgba(255,255,255,0.145) 0%,
          rgba(255,255,255,0.090) 35%,
          rgba(255,255,255,0.048) 70%,
          rgba(255,255,255,0.028) 100%);
      backdrop-filter: blur(90px) saturate(240%) brightness(1.05);
      -webkit-backdrop-filter: blur(90px) saturate(240%) brightness(1.05);
      /* Edge strokes */
      border: 0.5px solid rgba(255,255,255,0.16);
      /* Deep layered shadow system */
      box-shadow:
        /* Inner rim highlights */
        0 0 0 0.5px rgba(255,255,255,0.28) inset,
        0 2.5px 0   rgba(255,255,255,0.22) inset,
        0 0 32px    rgba(255,255,255,0.040) inset,
        /* Outer shadows â€” creates depth + lifts card off bg */
        0 0 0 0.5px rgba(0,0,0,0.60),
        0 50px 130px rgba(0,0,0,0.92),
        0 20px  50px rgba(0,0,0,0.75),
        0  6px  14px rgba(0,0,0,0.55);
      position: relative;
    }
    /* Prismatic top edge */
    .glass-shell::before {
      content: '';
      position: absolute; top: 0; left: 6%; right: 6%; height: 1px; pointer-events: none; z-index: 2;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255,255,255,0.18) 12%,
        rgba(255,255,255,0.95) 50%,
        rgba(255,255,255,0.18) 88%,
        transparent 100%);
      border-radius: 999px;
    }
    /* Subtle bottom glow edge */
    .glass-shell::after {
      content: '';
      position: absolute; bottom: 0; left: 18%; right: 18%; height: 1px; pointer-events: none;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.10), transparent);
    }

    /* â•â•â• INNER GLASS SURFACES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .glass-s {
      background: linear-gradient(145deg,
        rgba(255,255,255,0.092) 0%,
        rgba(255,255,255,0.042) 100%);
      backdrop-filter: blur(32px) saturate(180%);
      -webkit-backdrop-filter: blur(32px) saturate(180%);
      border: 0.5px solid rgba(255,255,255,0.11);
      box-shadow:
        0 1.5px 0 rgba(255,255,255,0.085) inset,
        0 0 18px rgba(255,255,255,0.025) inset,
        0 6px 28px rgba(0,0,0,0.38);
    }
    .glass-hi {
      background: linear-gradient(145deg,
        rgba(255,255,255,0.125) 0%,
        rgba(255,255,255,0.058) 100%);
      backdrop-filter: blur(32px) saturate(190%);
      -webkit-backdrop-filter: blur(32px) saturate(190%);
      border: 0.5px solid rgba(255,255,255,0.16);
      box-shadow:
        0 1.5px 0 rgba(255,255,255,0.11) inset,
        0 0 22px rgba(255,255,255,0.030) inset,
        0 8px 32px rgba(0,0,0,0.42);
    }

    /* â•â•â• SERVICE CARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .svc-card {
      background: rgba(255,255,255,0.068);
      border: 0.5px solid rgba(255,255,255,0.11);
      cursor: pointer;
      transition: background 0.20s ease, border-color 0.20s ease, box-shadow 0.20s ease, transform 0.20s ease;
    }
    .svc-card:hover:not(.svc-sel) {
      background: rgba(255,255,255,0.115);
      border-color: rgba(255,255,255,0.22);
      box-shadow: 0 8px 30px rgba(0,0,0,0.45), 0 0 0 0.5px rgba(255,255,255,0.08) inset;
    }
    .svc-sel {
      background: #ffffff;
      border-color: transparent !important;
      box-shadow:
        0 0 0 0.5px rgba(255,255,255,0.60) inset,
        0 1.5px 0 rgba(255,255,255,0.80) inset,
        0 10px 40px rgba(255,255,255,0.16),
        0  3px 10px rgba(0,0,0,0.35);
    }

    /* â•â•â• CATEGORY CHIP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .chip {
      padding: 6px 15px; border-radius: 999px;
      border: 0.5px solid rgba(255,255,255,0.11);
      background: rgba(255,255,255,0.055);
      color: rgba(255,255,255,0.42);
      font-family:'Jost',sans-serif; font-size:11px; font-weight:600; letter-spacing:0.05em;
      cursor:pointer; white-space:nowrap;
      transition: all 0.18s ease;
    }
    .chip:hover:not(.chip-on) { background: rgba(255,255,255,0.11); color: rgba(255,255,255,0.70); border-color: rgba(255,255,255,0.20); }
    .chip-on {
      background: #ffffff; color: #020207;
      border-color: transparent;
      box-shadow: 0 0 0 0.5px rgba(255,255,255,0.55) inset, 0 4px 18px rgba(255,255,255,0.13);
    }

    /* â•â•â• CALENDAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .cal-day { aspect-ratio:1; display:flex; align-items:center; justify-content:center; border-radius:9px; font-size:13px; font-weight:500; color:rgba(255,255,255,0.18); cursor:default; position:relative; }
    .cal-has {
      color:rgba(255,255,255,0.92); cursor:pointer;
      background:rgba(255,255,255,0.065); border:0.5px solid rgba(255,255,255,0.12);
    }
    .cal-has:hover:not(.cal-sel) { background:rgba(255,255,255,0.130); border-color:rgba(255,255,255,0.26); box-shadow: 0 2px 12px rgba(0,0,0,0.35); }
    .cal-sel {
      background: #ffffff !important; color: #020207 !important;
      border-color: transparent !important;
      box-shadow: 0 0 0 0.5px rgba(255,255,255,0.55) inset, 0 5px 22px rgba(255,255,255,0.18) !important;
    }
    .cal-dot { position:absolute; bottom:2px; left:50%; transform:translateX(-50%); width:3px; height:3px; border-radius:50%; background:rgba(255,255,255,0.50); }
    .cal-sel .cal-dot { background:rgba(0,0,0,0.30); }

    /* â•â•â• TIME SLOT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .tslot {
      padding:9px 6px; border-radius:10px;
      border:0.5px solid rgba(255,255,255,0.11); background:rgba(255,255,255,0.062);
      color:rgba(255,255,255,0.75); font-family:'Jost',sans-serif; font-size:12.5px; font-weight:500;
      text-align:center; cursor:pointer; transition:all 0.18s ease;
    }
    .tslot:hover:not(.tslot-on) { background:rgba(255,255,255,0.130); border-color:rgba(255,255,255,0.26); box-shadow:0 3px 14px rgba(0,0,0,0.38); }
    .tslot-on {
      background: #ffffff; color: #020207;
      border-color: transparent;
      box-shadow: 0 0 0 0.5px rgba(255,255,255,0.55) inset, 0 5px 18px rgba(255,255,255,0.15);
    }

    /* â•â•â• PROGRESS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .pb-track { height:3px; border-radius:999px; background:rgba(255,255,255,0.09); overflow:visible; position:relative; }
    .pb-fill {
      height:100%; border-radius:999px;
      background: linear-gradient(90deg, rgba(255,255,255,0.45) 0%, #ffffff 100%);
      box-shadow: 0 0 14px rgba(255,255,255,0.45), 0 0 5px rgba(255,255,255,0.80);
      transition: width 0.70s cubic-bezier(0.4,0,0.2,1);
    }
    .pb-glow::after {
      content:''; position:absolute; top:-3px; right:-20px; width:28px; height:calc(100% + 6px);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,1));
      border-radius:999px; filter:blur(4px);
      animation: pbShimmer 2s ease-in-out infinite;
    }
    @keyframes pbShimmer { 0%,100%{opacity:0;transform:translateX(-12px)} 50%{opacity:0.9;transform:translateX(0)} }

    /* â•â•â• STEP DOTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .sdot {
      width:20px; height:20px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-family:'Jost',sans-serif; font-size:9px; font-weight:800;
      border: 1.5px solid rgba(255,255,255,0.16); color:rgba(255,255,255,0.30);
      transition: all 0.35s ease;
    }
    .sdot-on {
      border-color: rgba(255,255,255,0.70); color: #ffffff;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.08), 0 0 18px rgba(255,255,255,0.22);
    }
    .sdot-done {
      background: #ffffff; border-color: transparent; color: #020207;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.15), 0 0 18px rgba(255,255,255,0.25);
    }

    /* â•â•â• INPUTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .inp {
      width:100%; background:rgba(255,255,255,0.068); border:0.5px solid rgba(255,255,255,0.13); border-radius:12px;
      padding:13px 15px; color:#ffffff; font-family:'Jost',sans-serif; font-size:13px; outline:none;
      transition: border-color 0.22s, background 0.22s, box-shadow 0.22s;
    }
    .inp::placeholder { color:rgba(255,255,255,0.22); }
    .inp:focus {
      border-color: rgba(255,255,255,0.42); background:rgba(255,255,255,0.095);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.09), 0 0 20px rgba(255,255,255,0.06);
    }
    .inp option { background:#0c0c14; color:#fff; }
    textarea.inp { resize:vertical; min-height:54px; line-height:1.58; }

    /* â•â•â• SAFETY YES/NO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .syn { flex:1; padding:9px 0; border-radius:10px; border:0.5px solid rgba(255,255,255,0.10); background:rgba(255,255,255,0.052); color:rgba(255,255,255,0.36); font-family:'Jost',sans-serif; font-size:12px; font-weight:600; cursor:pointer; transition:all 0.16s; }
    .syn:hover:not(.syn-on){ background:rgba(255,255,255,0.10); color:rgba(255,255,255,0.65); }
    .syn-on { background:#ffffff; color:#020207; border-color:transparent; box-shadow:0 0 0 0.5px rgba(255,255,255,0.50) inset, 0 4px 14px rgba(255,255,255,0.14); }

    /* â•â•â• DIVA TOGGLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .diva-btn { flex:1; padding:13px 8px; border-radius:13px; border:0.5px solid rgba(255,255,255,0.11); background:rgba(255,255,255,0.062); color:rgba(255,255,255,0.36); font-family:'Jost',sans-serif; font-size:12px; font-weight:600; cursor:pointer; transition:all 0.18s ease; }
    .diva-btn:hover:not(.diva-on){ background:rgba(255,255,255,0.11); border-color:rgba(255,255,255,0.22); }
    .diva-on { background:#ffffff; color:#020207; border-color:transparent; box-shadow:0 0 0 0.5px rgba(255,255,255,0.55) inset, 0 5px 22px rgba(255,255,255,0.12); }

    /* â•â•â• PRIMARY BUTTON â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn-p {
      background: #ffffff; color: #020207;
      border-radius:16px; padding:15px 0;
      font-family:'Jost',sans-serif; font-size:11.5px; font-weight:800; letter-spacing:0.12em; text-transform:uppercase;
      border:none; cursor:pointer; width:100%;
      box-shadow:
        0 0 0 0.5px rgba(255,255,255,0.50) inset,
        0 2px 0   rgba(255,255,255,0.65) inset,
        0 16px 44px rgba(255,255,255,0.12),
        0  5px 12px rgba(0,0,0,0.45);
      transition: transform 0.18s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.18s ease;
    }
    .btn-p:hover:not(:disabled) {
      transform: translateY(-3px) scale(1.005);
      box-shadow:
        0 0 0 0.5px rgba(255,255,255,0.60) inset,
        0 22px 60px rgba(255,255,255,0.16),
        0  8px 18px rgba(0,0,0,0.50);
    }
    .btn-p:active:not(:disabled) { transform:translateY(-1px) scale(0.998); }
    .btn-p:disabled {
      background:rgba(255,255,255,0.07); color:rgba(255,255,255,0.20);
      box-shadow:none; border:0.5px solid rgba(255,255,255,0.07); cursor:not-allowed;
    }

    /* â•â•â• GHOST BUTTON â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn-g {
      background:rgba(255,255,255,0.068); backdrop-filter:blur(16px);
      color:rgba(255,255,255,0.52);
      border-radius:16px; padding:15px 0;
      font-family:'Jost',sans-serif; font-size:11.5px; font-weight:700; letter-spacing:0.09em; text-transform:uppercase;
      border:0.5px solid rgba(255,255,255,0.13); cursor:pointer; width:100%;
      transition: all 0.18s ease;
    }
    .btn-g:hover { background:rgba(255,255,255,0.13); border-color:rgba(255,255,255,0.26); color:rgba(255,255,255,0.85); transform:translateY(-2px); }

    /* â•â•â• CART BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .cart-bar {
      background: linear-gradient(148deg, rgba(255,255,255,0.120) 0%, rgba(255,255,255,0.062) 100%);
      backdrop-filter: blur(32px) saturate(200%);
      border: 0.5px solid rgba(255,255,255,0.18);
      border-radius: 16px;
      box-shadow:
        0 1.5px 0 rgba(255,255,255,0.10) inset,
        0 6px 26px rgba(0,0,0,0.42);
    }

    /* â•â•â• ADDRESS DROPDOWN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .addr-dd { position:absolute; top:calc(100% + 5px); left:0; right:0; z-index:999; background:rgba(5,5,14,0.98); backdrop-filter:blur(32px); border:0.5px solid rgba(255,255,255,0.20); border-radius:14px; box-shadow:0 0 0 0.5px rgba(255,255,255,0.06) inset, 0 22px 50px rgba(0,0,0,0.80); overflow:hidden; }
    .addr-item { padding:11px 15px; cursor:pointer; border-top:0.5px solid rgba(255,255,255,0.055); transition:background 0.14s; }
    .addr-item:first-child { border-top:none; }
    .addr-item:hover { background:rgba(255,255,255,0.09); }

    /* â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .toast {
      position:fixed; left:50%; bottom:32px; transform:translateX(-50%);
      background:rgba(4,4,12,0.98); backdrop-filter:blur(32px);
      border:0.5px solid rgba(255,255,255,0.20); border-radius:999px;
      padding:10px 24px;
      font-family:'Jost',sans-serif; font-size:12px; font-weight:500; color:rgba(255,255,255,0.92);
      box-shadow: 0 0 0 0.5px rgba(255,255,255,0.07) inset, 0 24px 60px rgba(0,0,0,0.80);
      z-index:9999; white-space:nowrap;
    }

    /* â•â•â• SPINNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .spin { display:inline-block; width:16px; height:16px; border-radius:50%; border:2px solid rgba(4,4,10,0.14); border-top-color:rgba(4,4,10,0.85); animation:spinA 0.8s linear infinite; vertical-align:middle; }
    .spin-w { border-color:rgba(255,255,255,0.15); border-top-color:#ffffff; }
    @keyframes spinA { to { transform:rotate(360deg); } }

    /* â•â•â• SKELETON â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @keyframes sk { 0%,100%{opacity:0.35} 50%{opacity:0.72} }
    .skel { animation:sk 1.7s ease-in-out infinite; }

    /* â•â•â• SCROLLBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    ::-webkit-scrollbar { width:3px; }
    ::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.14); border-radius:2px; }

    /* â•â•â• FONT SHORTHANDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .abril { font-family:'Abril Fatface', Georgia, serif; }
    .corm  { font-family:'Cormorant Garamond', Georgia, serif; }
    .jost  { font-family:'Jost', sans-serif; }

    /* â•â•â• UTILITY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* Hairline divider */
    .line-divider { height:0.5px; background:linear-gradient(90deg, transparent, rgba(255,255,255,0.14), transparent); border:none; margin:0; }
  </style>

  <script>
    tailwind.config = { theme: { extend: {} } };
  </script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo } = React;
    const { motion, AnimatePresence } = FramerMotion;

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function calPad(n) { return String(n).padStart(2,'0'); }
    function fmtDate(ds) {
      if (!ds) return '';
      const [y,m,d] = ds.split('-').map(Number);
      const dt = new Date(y,m-1,d);
      const D=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
      const M=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      return `${D[dt.getDay()]}, ${d} ${M[m-1]} ${y}`;
    }
    function escH(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PROGRESS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function ProgressBar({ step }) {
      const CHECK = (
        <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3.5" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      );
      const labels = ['Services','Schedule','Details','Review'];
      return (
        <div className="w-full mt-4">
          <div className="flex items-center gap-1.5 w-full">
            {[1,2,3,4].map(i => {
              const done=i<step, act=i===step;
              return (
                <div key={i} className="pb-track flex-1">
                  <div className={'pb-fill'+(act?' pb-glow':'')} style={{ width: done?'100%': act?'55%':'0%' }} />
                </div>
              );
            })}
          </div>
          <div className="flex justify-between mt-2 px-0.5">
            {[1,2,3,4].map(i => {
              const done=i<step, act=i===step;
              return (
                <div key={i} className="flex flex-col items-center gap-1">
                  <div className={'sdot'+(done?' sdot-done':act?' sdot-on':'')}>
                    {done ? CHECK : i}
                  </div>
                  <span className="jost text-[8.5px] font-bold tracking-widest uppercase" style={{ color: act?'rgba(255,255,255,0.65)':done?'rgba(255,255,255,0.48)':'rgba(255,255,255,0.20)' }}>
                    {labels[i-1]}
                  </span>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function Header({ step, hide }) {
      return (
        <motion.header
          className="pb-4 relative z-10"
          initial={{ opacity:0, y:-24 }}
          animate={{ opacity:1, y:0 }}
          transition={{ duration:0.80, ease:[0.22,1,0.36,1] }}
        >
          {/* Spotlight glow behind logo */}
          <div style={{
            position:'absolute', top:-20, left:'50%', transform:'translateX(-50%)',
            width:160, height:80, borderRadius:'50%',
            background:'radial-gradient(ellipse at center, rgba(255,255,255,0.090) 0%, transparent 70%)',
            filter:'blur(12px)', pointerEvents:'none', zIndex:0,
          }}/>

          {/* Logo ring */}
          <div className="flex justify-center mb-3.5" style={{position:'relative',zIndex:1}}>
            <motion.div
              initial={{ scale:0.65, opacity:0, y:10 }}
              animate={{ scale:1,   opacity:1, y:0  }}
              transition={{ delay:0.15, type:'spring', stiffness:240, damping:20 }}
              style={{
                width:66, height:66, borderRadius:22, padding:2.5,
                background:'linear-gradient(150deg, #242424 0%, #080808 100%)',
                boxShadow:
                  '0 0 0 0.5px rgba(255,255,255,0.28) inset,' +
                  '0 1.5px 0 rgba(255,255,255,0.20) inset,' +
                  '0 0 0 0.5px rgba(0,0,0,0.80),' +
                  '0 16px 44px rgba(0,0,0,0.85),' +
                  '0 4px 12px rgba(0,0,0,0.65),' +
                  '0 0 32px rgba(255,255,255,0.06)',
                position:'relative', overflow:'hidden',
              }}
            >
              {/* Glass specular */}
              <div style={{ position:'absolute',inset:0,borderRadius:'inherit', background:'linear-gradient(135deg,rgba(255,255,255,0.20) 0%,rgba(255,255,255,0.04) 45%,transparent 100%)',pointerEvents:'none',zIndex:2 }}/>
              <img src="https://iili.io/fpiAjBj.jpg" alt="PhenomeBeauty"
                style={{ width:'100%',height:'100%',borderRadius:18,objectFit:'cover',display:'block',position:'relative',zIndex:1 }}/>
            </motion.div>
          </div>

          {/* Brand â€” Abril Fatface ONLY. Exactly one heading. */}
          <motion.div
            className="text-center"
            initial={{ opacity:0, y:10 }}
            animate={{ opacity:1, y:0  }}
            transition={{ delay:0.28, duration:0.65, ease:[0.22,1,0.36,1] }}
          >
            <div className="abril text-[24px] leading-none tracking-wide"
              style={{ color:'#ffffff', textShadow:'0 0 40px rgba(255,255,255,0.22), 0 2px 6px rgba(0,0,0,0.60)' }}>
              PhenomeBeauty
            </div>
            <div className="jost text-[8px] font-[800] tracking-[0.38em] uppercase mt-2"
              style={{ color:'rgba(255,255,255,0.28)', letterSpacing:'0.36em' }}>
              Mobile Beauty Studio
            </div>
          </motion.div>

          {/* Hairline accent */}
          {!hide && (
            <div style={{ width:28,height:0.5,margin:'13px auto 0',background:'linear-gradient(90deg,transparent,rgba(255,255,255,0.55),transparent)' }}/>
          )}

          {!hide && <ProgressBar step={step} />}
        </motion.header>
      );
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STEP 1 â€” SERVICES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function Step1({ services, selected, setSelected }) {
      const [cat, setCat] = useState(null);

      const groups = useMemo(() => {
        const g={};
        services.forEach(s=>{ const c=s.category||'Other'; if(!g[c])g[c]=[]; g[c].push(s); });
        return g;
      }, [services]);

      const cats = Object.keys(groups);
      useEffect(() => { if(!cat&&cats.length) setCat(cats[0]); }, [cats,cat]);

      const list = groups[cat] || [];
      const tot  = selected.reduce((a,s)=>a+Number(s.price),0);
      const dur  = selected.reduce((a,s)=>a+(Number(s.duration)||0),0);

      const toggle = s => {
        const idx = selected.findIndex(x=>String(x.id)===String(s.id));
        setSelected(idx>-1 ? selected.filter((_,i)=>i!==idx) : [...selected,s]);
      };

      if (!services.length) return (
        <div className="space-y-3">
          {[1,2,3].map(i=>(
            <div key={i} className="skel rounded-2xl p-4" style={{background:'rgba(255,255,255,0.05)',border:'0.5px solid rgba(255,255,255,0.06)'}}>
              <div className="rounded mb-2" style={{height:9,background:'rgba(255,255,255,0.07)',width:'58%'}}/>
              <div className="rounded" style={{height:7,background:'rgba(255,255,255,0.05)',width:'38%'}}/>
            </div>
          ))}
        </div>
      );

      return (
        <div className="flex flex-col gap-4">
          {/* Category chips */}
          <div className="flex gap-2 overflow-x-auto pb-1" style={{scrollbarWidth:'none'}}>
            {cats.map(c=>(
              <button key={c} className={'chip'+(c===cat?' chip-on':'')} onClick={()=>setCat(c)}>{c}</button>
            ))}
          </div>

          {/* Cards */}
          <div className="flex flex-col gap-2.5">
            <AnimatePresence mode="popLayout">
              {list.map((svc,i)=>{
                const sel=selected.some(x=>String(x.id)===String(svc.id));
                return (
                  <motion.div
                    key={svc.id}
                    initial={{opacity:0,y:10}} animate={{opacity:1,y:0}} exit={{opacity:0,scale:0.97}}
                    transition={{delay:i*0.04,duration:0.3,ease:[0.22,1,0.36,1]}}
                    whileHover={{scale:1.006}} whileTap={{scale:0.993}}
                    className={'svc-card rounded-2xl p-4 flex items-center gap-3'+(sel?' svc-sel':'')}
                    onClick={()=>toggle(svc)}
                  >
                    <div className="flex-1 min-w-0">
                      <div className="flex items-baseline justify-between gap-2 mb-1">
                        <span className="jost font-[600] text-[14.5px] truncate" style={{color:sel?'#04040a':'rgba(255,255,255,0.96)'}}>{svc.name}</span>
                        <span className="corm font-[500] text-[16px] shrink-0" style={{color:sel?'#04040a':'rgba(255,255,255,0.80)'}}> R{Number(svc.price).toFixed(0)}</span>
                      </div>
                      <p className="jost text-[11px] leading-relaxed" style={{color:sel?'rgba(4,4,10,0.52)':'rgba(255,255,255,0.37)'}}>{svc.description} Â· {svc.duration} min</p>
                    </div>
                    <motion.div
                      animate={{scale:sel?1:0,opacity:sel?1:0}}
                      transition={{type:'spring',stiffness:520,damping:28}}
                      className="shrink-0 w-[22px] h-[22px] rounded-full flex items-center justify-center"
                      style={{background:'#04040a'}}
                    >
                      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3.2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                    </motion.div>
                  </motion.div>
                );
              })}
            </AnimatePresence>
          </div>

          {/* Cart bar */}
          <AnimatePresence>
            {selected.length>0&&(
              <motion.div
                className="cart-bar p-3.5"
                initial={{opacity:0,y:16,scale:0.97}} animate={{opacity:1,y:0,scale:1}} exit={{opacity:0,y:10,scale:0.97}}
                transition={{type:'spring',stiffness:360,damping:28}}
              >
                <div className="flex items-center justify-between mb-2">
                  <span className="jost text-[9px] font-[800] tracking-[0.24em] uppercase" style={{color:'rgba(255,255,255,0.35)'}}>
                    {selected.length} service{selected.length>1?'s':''} Â· {dur} min
                  </span>
                  <span className="corm text-[18px] font-[500]" style={{color:'rgba(255,255,255,0.96)'}}>R{tot.toFixed(0)}</span>
                </div>
                {selected.map(s=>(
                  <div key={s.id} className="flex items-center justify-between gap-2 mb-1 last:mb-0">
                    <span className="jost text-[11px]" style={{color:'rgba(255,255,255,0.52)'}}>{s.name}</span>
                    <div className="flex items-center gap-2">
                      <span className="jost text-[11px] font-[600]" style={{color:'rgba(255,255,255,0.72)'}}>R{Number(s.price).toFixed(0)}</span>
                      <button onClick={e=>{e.stopPropagation();setSelected(selected.filter(x=>String(x.id)!==String(s.id)));}}
                        className="w-[18px] h-[18px] rounded-full jost text-[11px] flex items-center justify-center transition-all"
                        style={{color:'rgba(255,255,255,0.30)',background:'rgba(255,255,255,0.09)'}}>Ã—</button>
                    </div>
                  </div>
                ))}
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STEP 2 â€” SCHEDULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function Step2({ selDate, selTime, setSelDate, setSelTime }) {
      const now=new Date();
      const [y,setY]=useState(now.getFullYear());
      const [mo,setMo]=useState(now.getMonth());
      const [cache,setCache]=useState({});

      const key=()=>`${y}-${calPad(mo+1)}`;

      useEffect(()=>{
        const k=key();
        if(cache[k]?.loaded)return;
        setCache(c=>({...c,[k]:{loaded:false,slots:{}}}));
        fetch('/api?action=getMonthAvailability&month='+encodeURIComponent(k))
          .then(r=>r.json())
          .then(s=>setCache(c=>({...c,[k]:{loaded:true,slots:s||{}}})))
          .catch(()=>setCache(c=>({...c,[k]:{loaded:true,slots:{}}})));
      },[y,mo]);

      const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
      const DAYS=['Su','Mo','Tu','We','Th','Fr','Sa'];
      const today=new Date(); today.setHours(0,0,0,0);
      const dim=new Date(y,mo+1,0).getDate();
      const fdow=new Date(y,mo,1).getDay();
      const isPast=y<today.getFullYear()||(y===today.getFullYear()&&mo<today.getMonth());
      const k=key();
      const slots=cache[k]?.slots||{};
      const loading=!cache[k]?.loaded;
      const times=selDate?(slots[selDate]||[]):[];

      const prevMo=()=>{ if(isPast)return; if(mo===0){setMo(11);setY(v=>v-1);}else setMo(m=>m-1); };
      const nextMo=()=>{ if(mo===11){setMo(0);setY(v=>v+1);}else setMo(m=>m+1); };

      const cells=[];
      for(let i=0;i<fdow;i++)cells.push({e:true,k:'e'+i});
      for(let d=1;d<=dim;d++){
        const ds=`${y}-${calPad(mo+1)}-${calPad(d)}`;
        const dt=new Date(y,mo,d);
        cells.push({ d, ds, past:dt<today, tod:dt.getTime()===today.getTime(), times:loading?[]:(slots[ds]||[]), k:ds });
      }

      return (
        <div className="flex flex-col gap-5">
          <div className="glass-s rounded-[20px] p-4">
            <div className="flex items-center justify-between mb-4">
              <button onClick={prevMo} disabled={isPast}
                className="w-8 h-8 rounded-full flex items-center justify-center transition-all"
                style={{background:isPast?'rgba(255,255,255,0.03)':'rgba(255,255,255,0.08)',color:isPast?'rgba(255,255,255,0.16)':'rgba(255,255,255,0.65)',border:'0.5px solid rgba(255,255,255,0.10)',fontSize:18}}>
                â€¹
              </button>
              <span className="corm text-[17px] font-[400]" style={{color:'rgba(255,255,255,0.94)'}}>{MONTHS[mo]} {y}</span>
              <button onClick={nextMo}
                className="w-8 h-8 rounded-full flex items-center justify-center transition-all"
                style={{background:'rgba(255,255,255,0.08)',color:'rgba(255,255,255,0.65)',border:'0.5px solid rgba(255,255,255,0.10)',fontSize:18}}>
                â€º
              </button>
            </div>
            <div className="grid grid-cols-7 gap-1 mb-1.5">
              {DAYS.map(d=>(
                <div key={d} className="text-center jost text-[9px] font-[700] tracking-wide uppercase"
                  style={{color:'rgba(255,255,255,0.24)',paddingBottom:3}}>{d}</div>
              ))}
            </div>
            <div className="grid grid-cols-7 gap-1">
              {cells.map((c,i)=>{
                if(c.e)return <div key={c.k} className="cal-day"/>;
                const has=c.times.length>0;
                const sel=c.ds===selDate;
                return (
                  <motion.div
                    key={c.k}
                    className={'cal-day'+(sel?' cal-sel':has&&!c.past?' cal-has':'')}
                    onClick={()=>has&&!c.past&&setSelDate(c.ds)&&setSelTime('')}
                    onClick={()=>{ if(has&&!c.past){ setSelDate(c.ds); setSelTime(''); } }}
                    initial={{opacity:0,scale:0.75}} animate={{opacity:c.past?0.22:1,scale:1}}
                    transition={{delay:i*0.008,duration:0.22}}
                    whileHover={has&&!c.past&&!sel?{scale:1.10}:{}}
                    whileTap={has&&!c.past?{scale:0.94}:{}}
                  >
                    {c.d}
                    {has&&!sel&&<div className="cal-dot"/>}
                  </motion.div>
                );
              })}
            </div>
            {loading&&<div className="text-center mt-3"><span className="spin spin-w" style={{width:14,height:14}}/></div>}
          </div>

          <AnimatePresence>
            {selDate&&times.length>0&&(
              <motion.div className="glass-s rounded-[20px] p-4"
                initial={{opacity:0,y:14}} animate={{opacity:1,y:0}} exit={{opacity:0,y:8}}
                transition={{duration:0.35,ease:[0.22,1,0.36,1]}}>
                <div className="jost text-[9px] font-[800] tracking-[0.28em] uppercase mb-3" style={{color:'rgba(255,255,255,0.28)'}}>
                  Available Times
                </div>
                <div className="grid grid-cols-3 gap-2">
                  {times.map((t,i)=>(
                    <motion.div key={t} className={'tslot'+(t===selTime?' tslot-on':'')}
                      onClick={()=>setSelTime(t)}
                      initial={{opacity:0,scale:0.88}} animate={{opacity:1,scale:1}}
                      transition={{delay:i*0.04,duration:0.24}}
                      whileTap={{scale:0.95}}>
                      {t}
                    </motion.div>
                  ))}
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STEP 3 â€” DETAILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const SQ=[
      {k:'skin',     q:'Any skin conditions or sensitivities?',       h:'e.g. eczema, psoriasis, rosacea, keratosis pilaris.'},
      {k:'meds',     q:'Are you on any medications?',                 h:'Including topical or oral retinoids, blood thinners, antibiotics.'},
      {k:'allergies',q:'Known allergies to wax, resins, or latex?',   h:'Mention any previous reactions to beauty products.'},
      {k:'pregnant', q:'Currently pregnant or breastfeeding?',        h:'Some services may not be recommended.'},
      {k:'health',   q:'Any health conditions we should know about?', h:'Diabetes, compromised immunity, circulatory issues, etc.'},
      {k:'enviro',   q:'Significant environmental exposure?',         h:'Sun, heat, chemicals, frequent water or sweat contact.'},
      {k:'physical', q:'Frequent pressure or friction on wax areas?', h:'Work, sport, tight clothing, etc.'},
      {k:'hair',     q:'At least 2 weeks of uninterrupted hair growth?', h:'Required for effective waxing results.'},
    ];

    function Step3({ details, setDetails, diva, setDiva, safety, setSafety, cfg, feeData, setFeeData }) {
      const [sugg,setSugg]=useState([]);
      const dbRef=useRef(null);
      const acRef=useRef(null);

      useEffect(()=>{
        if(!cfg?.googleApiKey)return;
        if(window.google?.maps?.places)return;
        const s=document.createElement('script');
        s.src=`https://maps.googleapis.com/maps/api/js?key=${cfg.googleApiKey}&libraries=places`;
        s.async=true; document.head.appendChild(s);
      },[cfg?.googleApiKey]);

      const handleAddr=v=>{
        setDetails(d=>({...d,address:v,addrOk:false}));
        setSugg([]);
        clearTimeout(dbRef.current);
        if(!v||v.length<4)return;
        dbRef.current=setTimeout(()=>{
          if(window.google?.maps?.places){
            if(!acRef.current)acRef.current=new window.google.maps.places.AutocompleteService();
            acRef.current.getPlacePredictions({input:v,componentRestrictions:{country:'za'}},(p)=>setSugg(p||[]));
          } else {
            fetch('/api?action=getAddressSuggestions&input='+encodeURIComponent(v)).then(r=>r.json()).then(d=>setSugg(d||[])).catch(()=>{});
          }
        },360);
      };

      const pickAddr=p=>{
        const addr=p.description||(p.main_text+', '+p.secondary_text);
        setDetails(d=>({...d,address:addr,addrOk:true}));
        setSugg([]);
        fetch('/api?action=getCallOutFee&address='+encodeURIComponent(addr))
          .then(r=>r.json()).then(d=>setFeeData({fee:d.fee||0,oneWayKm:d.oneWayKm||0,roundTripKm:d.roundTripKm||0})).catch(()=>{});
      };

      const fmtPhone=v=>{ let d=v.replace(/\D/g,'').slice(0,10); return d.length>6?d.slice(0,3)+' '+d.slice(3,6)+' '+d.slice(6):d.length>3?d.slice(0,3)+' '+d.slice(3):d; };

      return (
        <div className="flex flex-col gap-4">
          {/* Diva type */}
          <div>
            <div className="jost text-[9px] font-[800] tracking-[0.26em] uppercase mb-2.5" style={{color:'rgba(255,255,255,0.28)'}}>New or returning client?</div>
            <div className="flex gap-2">
              {[['new','âœ¨ New Diva'],['existing','ğŸ’… Returning Diva']].map(([t,l])=>(
                <button key={t} className={'diva-btn'+(diva===t?' diva-on':'')} onClick={()=>setDiva(t)}>{l}</button>
              ))}
            </div>
          </div>

          {/* Fields */}
          {[['Full Name','text','Your name','name'],['Phone Number','tel','078 123 4567','phone'],['Email Address','email','you@email.com','email']].map(([lbl,type,ph,field])=>(
            <div key={field}>
              <label className="jost text-[9.5px] font-[800] tracking-[0.18em] uppercase block mb-1.5" style={{color:'rgba(255,255,255,0.40)'}}>{lbl}</label>
              <input className="inp" type={type} placeholder={ph}
                value={details[field]}
                onChange={e=>setDetails(d=>({...d,[field]:field==='phone'?fmtPhone(e.target.value):e.target.value}))} />
            </div>
          ))}

          {/* Address */}
          <div>
            <label className="jost text-[9.5px] font-[800] tracking-[0.18em] uppercase block mb-1.5" style={{color:'rgba(255,255,255,0.40)'}}>Service Address</label>
            <div className="relative">
              <input className="inp" placeholder="Start typing your addressâ€¦" autoComplete="off"
                value={details.address}
                onChange={e=>handleAddr(e.target.value)} />
              {sugg.length>0&&(
                <div className="addr-dd">
                  {sugg.map((p,i)=>{
                    const m=p.structured_formatting?.main_text||p.description||'';
                    const s=p.structured_formatting?.secondary_text||'';
                    return (
                      <div key={i} className="addr-item" onClick={()=>pickAddr(p)}>
                        <div className="jost text-[12.5px] font-[500]" style={{color:'rgba(255,255,255,0.90)'}}>{m}</div>
                        {s&&<div className="jost text-[10.5px] mt-0.5" style={{color:'rgba(255,255,255,0.34)'}}>{s}</div>}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
            {feeData.fee>0&&(
              <motion.div initial={{opacity:0,y:-4}} animate={{opacity:1,y:0}} className="jost text-[10.5px] mt-1.5" style={{color:'rgba(255,255,255,0.36)'}}>
                Call-out: <strong style={{color:'rgba(255,255,255,0.68)',fontWeight:600}}>R{feeData.fee}</strong> Â· {feeData.roundTripKm} km
              </motion.div>
            )}
          </div>

          {/* Source */}
          <div>
            <label className="jost text-[9.5px] font-[800] tracking-[0.18em] uppercase block mb-1.5" style={{color:'rgba(255,255,255,0.40)'}}>How did you find us?</label>
            <select className="inp" value={details.source} onChange={e=>setDetails(d=>({...d,source:e.target.value}))}>
              <option value="">â€” Select â€”</option>
              {['Instagram','TikTok','Facebook','Word of mouth','Google','Existing client','Other'].map(o=><option key={o} value={o}>{o}</option>)}
            </select>
          </div>

          {/* Safety */}
          <AnimatePresence>
            {diva==='new'&&(
              <motion.div initial={{opacity:0,height:0}} animate={{opacity:1,height:'auto'}} exit={{opacity:0,height:0}}
                transition={{duration:0.4,ease:[0.22,1,0.36,1]}} className="overflow-hidden">
                <div className="glass-s rounded-[18px] p-4 flex flex-col gap-4">
                  <div className="jost text-[9px] font-[800] tracking-[0.26em] uppercase" style={{color:'rgba(255,255,255,0.26)'}}>Health & Safety Consultation</div>
                  {SQ.map(q=>(
                    <div key={q.k}>
                      <div className="jost text-[12.5px] font-[500] mb-0.5" style={{color:'rgba(255,255,255,0.72)',lineHeight:1.4}}>{q.q}</div>
                      <div className="jost text-[10.5px] mb-2" style={{color:'rgba(255,255,255,0.28)',lineHeight:1.4}}>{q.h}</div>
                      <div className="flex gap-2">
                        {['no','yes'].map(v=>(
                          <button key={v} className={'syn'+(safety[q.k]===v?' syn-on':'')} onClick={()=>setSafety(s=>({...s,[q.k]:v}))}>
                            {v==='yes'?'Yes':'No'}
                          </button>
                        ))}
                      </div>
                      {safety[q.k]==='yes'&&q.k!=='pregnant'&&q.k!=='hair'&&(
                        <motion.div initial={{opacity:0,height:0}} animate={{opacity:1,height:'auto'}} className="overflow-hidden mt-2">
                          <textarea className="inp" maxLength={400} placeholder="Please describeâ€¦"
                            value={details['sq_'+q.k]||''}
                            onChange={e=>setDetails(d=>({...d,['sq_'+q.k]:e.target.value}))} />
                        </motion.div>
                      )}
                    </div>
                  ))}
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STEP 4 â€” REVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function Step4({ selected, selDate, selTime, details, feeData }) {
      const svc = selected.reduce((a,s)=>a+Number(s.price),0);
      const tot = svc+(feeData.fee||0);
      const dep = Math.round(tot*50)/100;
      const bal = Math.round((tot-dep)*100)/100;

      return (
        <div className="flex flex-col gap-3">
          <div className="glass-s rounded-[18px] p-4">
            <div className="jost text-[9px] font-[800] tracking-[0.26em] uppercase mb-3" style={{color:'rgba(255,255,255,0.26)'}}>Appointment</div>
            {[['Date',fmtDate(selDate)],['Time',selTime],['Address',details.address]].map(([k,v])=>(
              <div key={k} className="flex justify-between gap-3 mb-2.5 last:mb-0">
                <span className="jost text-[11px]" style={{color:'rgba(255,255,255,0.30)'}}>{k}</span>
                <span className="jost text-[12px] text-right font-[500] max-w-[62%]" style={{color:'rgba(255,255,255,0.76)'}}>{v}</span>
              </div>
            ))}
          </div>

          <div className="glass-s rounded-[18px] p-4">
            <div className="jost text-[9px] font-[800] tracking-[0.26em] uppercase mb-3" style={{color:'rgba(255,255,255,0.26)'}}>Services Booked</div>
            {selected.map(s=>(
              <div key={s.id} className="flex justify-between gap-2 mb-2 last:mb-0">
                <span className="jost text-[12px]" style={{color:'rgba(255,255,255,0.62)'}}>{s.name}</span>
                <span className="jost text-[12px] font-[600]" style={{color:'rgba(255,255,255,0.76)'}}>R{Number(s.price).toFixed(0)}</span>
              </div>
            ))}
          </div>

          <div className="glass-hi rounded-[18px] p-4">
            <div className="flex justify-between mb-2">
              <span className="jost text-[11px]" style={{color:'rgba(255,255,255,0.33)'}}>Services</span>
              <span className="jost text-[12px]" style={{color:'rgba(255,255,255,0.65)'}}>R{svc.toFixed(0)}</span>
            </div>
            <div className="flex justify-between mb-3">
              <span className="jost text-[11px]" style={{color:'rgba(255,255,255,0.33)'}}>Call-out fee</span>
              <span className="jost text-[12px]" style={{color:'rgba(255,255,255,0.65)'}}>{feeData.fee>0?`R${feeData.fee}`:'â€”'}</span>
            </div>
            <div style={{borderTop:'0.5px solid rgba(255,255,255,0.08)',marginBottom:12}}/>
            <div className="flex justify-between items-baseline mb-3">
              <span className="jost text-[10px] font-[700] tracking-wider uppercase" style={{color:'rgba(255,255,255,0.28)'}}>Total</span>
              <span className="corm text-[27px] font-[400]" style={{color:'rgba(255,255,255,0.98)'}}>R{tot.toFixed(0)}</span>
            </div>
            <div className="rounded-[12px] p-3 flex justify-between items-center" style={{background:'rgba(255,255,255,0.07)',border:'0.5px solid rgba(255,255,255,0.12)'}}>
              <div>
                <div className="jost text-[10.5px]" style={{color:'rgba(255,255,255,0.35)'}}>Deposit due now (50%)</div>
                <div className="jost text-[10px] mt-0.5" style={{color:'rgba(255,255,255,0.22)'}}>Balance R{bal.toFixed(0)} due on the day</div>
              </div>
              <div className="corm text-[22px] font-[400]" style={{color:'rgba(255,255,255,0.97)'}}>R{dep.toFixed(0)}</div>
            </div>
          </div>

          <p className="jost text-[10.5px] text-center" style={{color:'rgba(255,255,255,0.22)',lineHeight:1.75}}>
            By making payment you agree to our{' '}
            <a href="/policy.html?terms" target="_blank" style={{color:'rgba(255,255,255,0.46)',textDecoration:'underline',textUnderlineOffset:2}}>Terms &amp; Conditions</a>
          </p>
        </div>
      );
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SUCCESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function SuccessScreen({ data }) {
      return (
        <motion.div className="flex flex-col items-center text-center py-4"
          initial={{opacity:0,scale:0.94}} animate={{opacity:1,scale:1}}
          transition={{duration:0.65,ease:[0.22,1,0.36,1]}}>
          <motion.div
            className="w-[70px] h-[70px] rounded-full flex items-center justify-center mb-5"
            style={{background:'rgba(255,255,255,0.97)',boxShadow:'0 0 0 0.5px rgba(255,255,255,0.40) inset,0 14px 46px rgba(255,255,255,0.16)'}}
            initial={{scale:0,rotate:-25}} animate={{scale:1,rotate:0}}
            transition={{delay:0.18,type:'spring',stiffness:280,damping:22}}>
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#04040a" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </motion.div>
          <div className="corm text-[26px] font-[300] mb-1.5" style={{color:'rgba(255,255,255,0.97)'}}>You're booked!</div>
          <div className="jost text-[11.5px] mb-5" style={{color:'rgba(255,255,255,0.38)'}}>
            Deposit confirmed Â· Confirmation email on its way ğŸ“§
          </div>
          {data&&(
            <motion.div className="w-full glass-s rounded-[18px] p-4 text-left"
              initial={{opacity:0,y:14}} animate={{opacity:1,y:0}} transition={{delay:0.35}}>
              {[['Date',fmtDate(data.date)],['Time',data.time],['Services',data.services],['Deposit','R'+(data.deposit||'0')+' âœ…'],['Balance','R'+(data.balance||'0')+' on the day']]
                .map(([k,v])=>(
                  <div key={k} className="flex justify-between gap-3 mb-2.5 last:mb-0">
                    <span className="jost text-[11px]" style={{color:'rgba(255,255,255,0.30)'}}>{k}</span>
                    <span className="jost text-[12px] text-right font-[500]" style={{color:'rgba(255,255,255,0.72)'}}>{v}</span>
                  </div>
                ))
              }
              {data.bookingId&&(
                <div className="text-center pt-2.5 mt-1" style={{borderTop:'0.5px solid rgba(255,255,255,0.06)'}}>
                  <span className="jost text-[9.5px]" style={{color:'rgba(255,255,255,0.18)',letterSpacing:'0.06em'}}>Ref: {data.bookingId}</span>
                </div>
              )}
            </motion.div>
          )}
        </motion.div>
      );
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const SK=['skin','meds','allergies','pregnant','health','enviro','physical','hair'];

    function App() {
      const [step,  setStep]  = useState(1);
      const [dir,   setDir]   = useState(1);
      const [busy,  setBusy]  = useState(false);
      const [succ,  setSucc]  = useState(null);

      const [cfg,      setCfg]      = useState({});
      const [svcs,     setSvcs]     = useState([]);
      const [selected, setSelected] = useState([]);

      const [selDate, setSelDate] = useState('');
      const [selTime, setSelTime] = useState('');

      const [details, setDetails] = useState({ name:'',phone:'',email:'',address:'',source:'',addrOk:false });
      const [diva,    setDiva]    = useState('new');
      const [safety,  setSafety]  = useState({});
      const [fee,     setFee]     = useState({ fee:0,oneWayKm:0,roundTripKm:0 });

      const [toast, setToast] = useState(null);
      const toastRef=useRef(null);
      const showToast=(msg,err=false)=>{
        clearTimeout(toastRef.current);
        setToast({msg,err,id:Date.now()});
        toastRef.current=setTimeout(()=>setToast(null),3800);
      };

      // Handle Yoco return
      useEffect(()=>{
        const p=new URLSearchParams(window.location.search);
        const ps=p.get('payment'), pr=p.get('ref');
        if(ps){
          window.history.replaceState({},'',(window.location.pathname));
          if(ps==='success'&&pr){ window.location.replace('/thankyou.html?ref='+encodeURIComponent(pr)); return; }
          if(ps==='balance-success'&&pr){
            fetch('/api/check-payment?ref='+encodeURIComponent(pr)).then(r=>r.json()).then(d=>setSucc({type:'balance',data:d})).catch(()=>{});
          }
          if(ps==='cancelled'||ps==='balance-cancelled') showToast('Payment cancelled â€” your slot is still held.',true);
        }
      },[]);

      // Load data
      useEffect(()=>{
        fetch('/api?action=getConfig').then(r=>r.json()).then(c=>setCfg(c||{})).catch(()=>{});
        fetch('/api?action=getServices').then(r=>r.json()).then(d=>setSvcs(Array.isArray(d)?d:[])).catch(()=>showToast('Unable to load services â€” please refresh',true));
      },[]);

      // Can proceed?
      const phone=details.phone.replace(/\D/g,'');
      const detOk=details.name.trim().length>=2&&/^0\d{9}$/.test(phone)&&/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(details.email.trim())&&details.address.trim().length>=5&&(diva!=='new'||SK.every(k=>safety[k]==='yes'||safety[k]==='no'));
      const canGo=step===1?selected.length>0:step===2?!!selDate&&!!selTime:step===3?detOk:true;

      const go=n=>{ setDir(n); setStep(s=>s+n); window.scrollTo({top:0,behavior:'smooth'}); };

      // Submit
      const submit=async()=>{
        if(busy)return; setBusy(true);
        const svc=selected.reduce((a,s)=>a+Number(s.price),0);
        const tot=svc+(fee.fee||0);
        const dep=Math.round(tot*50)/100;
        const bal=Math.round((tot-dep)*100)/100;
        const safetyData=diva==='new'?{
          skinConditions: safety.skin==='yes'?(details.sq_skin||'').slice(0,500):'None',
          medications:    safety.meds==='yes'?(details.sq_meds||'').slice(0,500):'None',
          allergies:      safety.allergies==='yes'?(details.sq_allergies||'').slice(0,500):'None',
          pregnant:       safety.pregnant==='yes',
          healthConditions: safety.health==='yes'?(details.sq_health||'').slice(0,500):'None',
          environmental:  safety.enviro==='yes'?(details.sq_enviro||'').slice(0,300):'None',
          physical:       safety.physical==='yes'?(details.sq_physical||'').slice(0,300):'None',
          hairLengthOk:   safety.hair==='yes',
          additionalInfo: '',
        }:null;
        const body={
          services:selected, date:selDate, time:selTime,
          name:details.name.trim().slice(0,80),
          phone:phone.slice(0,15),
          email:details.email.trim().slice(0,120),
          address:details.address.trim().slice(0,200),
          source:details.source,
          divaType:diva, safety:safetyData, policyAgreed:true,
          servicesTotal:svc, callOutFee:fee.fee||0, totalAmount:tot,
          depositAmount:dep, balanceDue:bal,
          oneWayKm:fee.oneWayKm, roundTripKm:fee.roundTripKm,
        };
        try {
          const res=await fetch('/api/book',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
          const r=await res.json();
          if(!r?.success){ showToast((r?.error)||'Booking failed â€” please try again',true); setBusy(false); return; }
          if(r.paymentUrl){ window.location.href=r.paymentUrl; }
          else {
            setSucc({type:'deposit',data:{bookingId:r.bookingId||'',name:details.name.trim(),date:selDate,time:selTime,services:selected.map(s=>s.name).join(', '),deposit:String(r.depositAmount||'0'),balance:String(r.balanceDue||'0')}});
            setBusy(false);
          }
        } catch { showToast('Network error â€” please try again',true); setBusy(false); }
      };

      const vars={
        enter: d=>({ x:d>0?44:-44, opacity:0, scale:0.965 }),
        center:{ x:0, opacity:1, scale:1 },
        exit:  d=>({ x:d>0?-44:44, opacity:0, scale:0.965 }),
      };

      const labels=['Choose Services','Select Date & Time','Your Details','Review & Pay'];
      const isSucc=!!succ;

      return (
        <div className="relative min-h-screen flex items-stretch justify-center">
          <div className="bg-canvas"/>

          <div className="relative z-10 w-full max-w-[520px] px-3 py-4 flex flex-col">
              <div className="glass-shell relative rounded-[28px] flex flex-col flex-1 px-5 py-6 overflow-hidden">
              {/* Inner glass spotlight */}
              <div style={{position:"absolute",top:-50,left:"50%",transform:"translateX(-50%)",width:"85%",height:110,borderRadius:"50%",pointerEvents:"none",zIndex:0,background:"radial-gradient(ellipse at center, rgba(255,255,255,0.058) 0%, transparent 70%)",filter:"blur(20px)"}}/>

              <Header step={step} hide={isSucc}/>

              {/* Step label */}
              {!isSucc&&(
                <AnimatePresence mode="wait">
                  <motion.div key={step}
                    className="jost text-[9px] font-[800] tracking-[0.28em] uppercase mb-4 text-center"
                    style={{color:'rgba(255,255,255,0.26)'}}
                    initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}} transition={{duration:0.22}}>
                    {labels[step-1]}
                  </motion.div>
                </AnimatePresence>
              )}

              {/* Content */}
              <div className="flex-1 overflow-y-auto" style={{paddingBottom:isSucc?0:86}}>
                {isSucc?(
                  <SuccessScreen data={succ?.data}/>
                ):(
                  <AnimatePresence mode="wait" custom={dir}>
                    <motion.div key={step} custom={dir} variants={vars}
                      initial="enter" animate="center" exit="exit"
                      transition={{type:'spring',stiffness:340,damping:32,mass:0.88}}>
                      {step===1&&<Step1 services={svcs} selected={selected} setSelected={setSelected}/>}
                      {step===2&&<Step2 selDate={selDate} selTime={selTime} setSelDate={d=>{setSelDate(d);setSelTime('');}} setSelTime={setSelTime}/>}
                      {step===3&&<Step3 details={details} setDetails={setDetails} diva={diva} setDiva={setDiva} safety={safety} setSafety={setSafety} cfg={cfg} feeData={fee} setFeeData={setFee}/>}
                      {step===4&&<Step4 selected={selected} selDate={selDate} selTime={selTime} details={details} feeData={fee}/>}
                    </motion.div>
                  </AnimatePresence>
                )}
              </div>

              {/* Action bar */}
              {!isSucc&&(
                <motion.div
                  className="absolute bottom-0 left-0 right-0 px-5 pb-5 pt-5"
                  style={{background:'linear-gradient(to top, rgba(4,4,10,0.88) 0%, rgba(4,4,10,0.50) 65%, transparent 100%)',backdropFilter:'blur(10px)'}}
                  initial={{opacity:0,y:20}} animate={{opacity:1,y:0}} transition={{delay:0.28,duration:0.5}}>
                  <div className="flex gap-3">
                    {step>1&&(
                      <motion.button className="btn-g" style={{maxWidth:100}} onClick={()=>go(-1)} whileTap={{scale:0.97}}>Back</motion.button>
                    )}
                    <motion.button
                      className="btn-p"
                      disabled={!canGo||busy}
                      onClick={()=>{ if(step<4)go(1); else submit(); }}
                      whileTap={canGo&&!busy?{scale:0.98}:{}}
                    >
                      {busy?(
                        <span><span className="spin mr-2"/>Redirectingâ€¦</span>
                      ): step===4?'Proceed to Payment':'Continue â†’'}
                    </motion.button>
                  </div>
                </motion.div>
              )}

            </div>
          </div>

          {/* Toast */}
          <AnimatePresence>
            {toast&&(
              <motion.div key={toast.id} className="toast"
                style={toast.err?{color:'rgba(255,115,115,0.95)',borderColor:'rgba(255,100,100,0.30)'}:{}}
                initial={{y:44,opacity:0,x:'-50%'}} animate={{y:0,opacity:1,x:'-50%'}} exit={{y:20,opacity:0,x:'-50%'}}
                transition={{type:'spring',stiffness:400,damping:30}}>
                {toast.msg}
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
